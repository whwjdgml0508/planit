{% extends 'base.html' %}
{% load timetable_extras %}

{% block title %}ì‹œê°„í‘œ ê´€ë¦¬ - PlanIt{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ğŸ“… ì‹œê°„í‘œ ê´€ë¦¬</h2>
                <div>
                    <button type="button" class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="fas fa-question-circle"></i> ì‚¬ìš©ë²•
                    </button>
                    <a href="{% url 'timetable:subject_list' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-book"></i> ê³¼ëª© ê´€ë¦¬
                    </a>
                    <a href="{% url 'timetable:index' %}" class="btn btn-success">
                        <i class="fas fa-eye"></i> ì‹œê°„í‘œ ë³´ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ê³¼ëª© ëª©ë¡ -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“š ë“±ë¡ëœ ê³¼ëª©</h5>
                    <small class="text-muted">ê³¼ëª©ì„ ì„ íƒí•˜ê³  ì—¬ëŸ¬ ì‹œê°„ì— ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if subjects %}
                        {% for subject in subjects %}
                        <div class="subject-item mb-2 p-2 border rounded" 
                             data-subject-id="{{ subject.id }}"
                             data-subject-name="{{ subject.name }}"
                             data-subject-color="{{ subject.color }}"
                             style="cursor: pointer; border-color: {{ subject.color }};">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <strong style="color: {{ subject.color }};">{{ subject.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ subject.professor|default:"êµìˆ˜ ë¯¸ì •" }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge" style="background-color: {{ subject.color }};">
                                        {{ subject.credits }}í•™ì 
                                    </span>
                                    {% if subject.time_slots.all %}
                                    <br>
                                    <small class="text-success">
                                        <i class="fas fa-check"></i> ë°°ì¹˜ë¨
                                    </small>
                                    {% else %}
                                    <br>
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle"></i> ë¯¸ë°°ì¹˜
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-2 d-flex gap-1">
                                <a href="{% url 'timetable:subject_edit' subject.pk %}" 
                                   class="btn btn-sm btn-outline-secondary flex-grow-1"
                                   onclick="event.stopPropagation();">
                                    <i class="fas fa-edit"></i> ìˆ˜ì •
                                </a>
                                <a href="{% url 'timetable:subject_delete' subject.pk %}" 
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="event.stopPropagation();">
                                    <i class="fas fa-trash"></i> ì‚­ì œ
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-book fa-2x text-muted mb-2"></i>
                            <p class="text-muted">ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            <a href="{% url 'timetable:subject_create' %}" class="btn btn-primary btn-sm">
                                ê³¼ëª© ì¶”ê°€
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- ì„ íƒëœ ê³¼ëª© ì •ë³´ -->
            <div class="card mt-3" id="selected-subject-info" style="display: none;">
                <div class="card-header">
                    <h6 class="mb-0">ì„ íƒëœ ê³¼ëª©</h6>
                </div>
                <div class="card-body">
                    <div id="subject-details"></div>
                    <div class="mt-2">
                        <label for="location-input" class="form-label">ê°•ì˜ì‹¤</label>
                        <input type="text" class="form-control form-control-sm" id="location-input" placeholder="ê°•ì˜ì‹¤ ì…ë ¥">
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹œê°„í‘œ -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ—“ï¸ ì‹œê°„í‘œ</h5>
                    <small class="text-muted">ê³¼ëª©ì„ ì„ íƒí•œ í›„ ì›í•˜ëŠ” ì‹œê°„ì„ í´ë¦­í•˜ì„¸ìš”</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered timetable-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">êµì‹œ</th>
                                    {% for day in days %}
                                    <th class="text-center">{{ day_names|lookup:day }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in periods %}
                                <tr>
                                    <td class="text-center align-middle">
                                        <strong>{{ period }}êµì‹œ</strong><br>
                                        <small class="text-muted">{{ period_times|get_item:period }}</small>
                                    </td>
                                    {% for day in days %}
                                    <td class="timetable-cell text-center align-middle" 
                                        data-day="{{ day }}" 
                                        data-period="{{ period }}"
                                        style="height: 80px; cursor: pointer;">
                                        {% if timetable_data|get_item:day|get_item:period %}
                                            {% with slot_data=timetable_data|get_item:day|get_item:period %}
                                            <div class="subject-slot rounded p-2 h-100 d-flex flex-column justify-content-center"
                                                 style="background-color: {{ slot_data.subject.color }}; color: white;">
                                                <strong style="font-size: 0.9em;">{{ slot_data.subject.name }}</strong>
                                                {% if slot_data.time_slot.location %}
                                                <small>{{ slot_data.time_slot.location }}</small>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-light mt-1 remove-btn" 
                                                        data-day="{{ day }}" 
                                                        data-period="{{ period }}"
                                                        style="font-size: 0.7em;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% endwith %}
                                        {% else %}
                                            <div class="empty-slot h-100 d-flex align-items-center justify-content-center">
                                                <i class="fas fa-plus text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‚¬ìš©ë²• ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‹œê°„í‘œ ê´€ë¦¬ ì‚¬ìš©ë²•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-primary">ğŸ“š í•˜ë‚˜ì˜ ê³¼ëª©ì„ ì—¬ëŸ¬ ì‹œê°„ì— ë°°ì¹˜í•˜ê¸°</h6>
                <ol>
                    <li>ì™¼ìª½ì—ì„œ ì‹œê°„í‘œì— ì¶”ê°€í•  ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</li>
                    <li>í•„ìš”ì‹œ ê°•ì˜ì‹¤ì„ ì…ë ¥í•˜ì„¸ìš”</li>
                    <li>ì‹œê°„í‘œì—ì„œ ì›í•˜ëŠ” ì‹œê°„ì„ í´ë¦­í•˜ì—¬ ê³¼ëª©ì„ ë°°ì¹˜í•˜ì„¸ìš”</li>
                    <li><strong>ê°™ì€ ê³¼ëª©ì„ ì—¬ëŸ¬ ìš”ì¼/ì‹œê°„ì— ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</strong></li>
                    <li>ì´ë¯¸ ë°°ì¹˜ëœ ê³¼ëª©ì€ X ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                </ol>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>ì˜ˆì‹œ:</strong> "ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë˜ë°" ê³¼ëª©ì„ ì›”ìš”ì¼ 1êµì‹œì™€ ìˆ˜ìš”ì¼ 3êµì‹œì— ëª¨ë‘ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timetable-table {
    table-layout: fixed !important;
    width: 100% !important;
}

.subject-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    transition: all 0.2s;
}

.subject-item.selected {
    background-color: #e3f2fd;
    border-color: #2196f3 !important;
}

.timetable-cell {
    height: 80px !important;
    min-height: 80px !important;
    max-height: 80px !important;
    vertical-align: middle !important;
    padding: 4px !important;
}

.timetable-cell:hover .empty-slot {
    background-color: #f0f0f0;
}

.timetable-cell.can-add:hover {
    background-color: #e8f5e8;
}

.subject-slot {
    height: 100% !important;
    min-height: 100% !important;
    max-height: 100% !important;
    overflow: hidden !important;
}

.empty-slot {
    height: 100% !important;
    min-height: 100% !important;
    max-height: 100% !important;
}

.remove-btn {
    opacity: 0;
    transition: opacity 0.2s;
}

.subject-slot:hover .remove-btn {
    opacity: 1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedSubject = null;
    
    // ê³¼ëª© ì„ íƒ
    document.querySelectorAll('.subject-item').forEach(item => {
        item.addEventListener('click', function() {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.subject-item').forEach(i => i.classList.remove('selected'));
            
            // í˜„ì¬ ì„ íƒ
            this.classList.add('selected');
            selectedSubject = {
                id: this.dataset.subjectId,
                name: this.dataset.subjectName,
                color: this.dataset.subjectColor
            };
            
            // ì„ íƒëœ ê³¼ëª© ì •ë³´ í‘œì‹œ
            document.getElementById('selected-subject-info').style.display = 'block';
            document.getElementById('subject-details').innerHTML = `
                <strong style="color: ${selectedSubject.color};">${selectedSubject.name}</strong>
            `;
            
            // ì‹œê°„í‘œ ì…€ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateTimetableCells();
        });
    });
    
    // ì‹œê°„í‘œ ì…€ í´ë¦­ (ê³¼ëª© ì¶”ê°€)
    document.querySelectorAll('.timetable-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            console.log('ì‹œê°„í‘œ ì…€ í´ë¦­ë¨');
            
            if (!selectedSubject) {
                alert('ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const day = this.dataset.day;
            const period = this.dataset.period;
            const location = document.getElementById('location-input').value;
            
            console.log('ì„ íƒëœ ì •ë³´:', {
                subject: selectedSubject,
                day: day,
                period: period,
                location: location
            });
            
            // ì´ë¯¸ ê³¼ëª©ì´ ìˆëŠ” ê²½ìš°
            if (this.querySelector('.subject-slot')) {
                console.log('ì´ë¯¸ ê³¼ëª©ì´ ìˆëŠ” ì…€ì…ë‹ˆë‹¤.');
                return;
            }
            
            // AJAXë¡œ ê³¼ëª© ì¶”ê°€
            addToTimetable(selectedSubject.id, day, period, location);
        });
    });
    
    // ê³¼ëª© ì œê±°
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-btn')) {
            e.stopPropagation();
            const btn = e.target.closest('.remove-btn');
            const day = btn.dataset.day;
            const period = btn.dataset.period;
            
            removeFromTimetable(day, period);
        }
    });
    
    function updateTimetableCells() {
        document.querySelectorAll('.timetable-cell').forEach(cell => {
            if (!cell.querySelector('.subject-slot')) {
                cell.classList.add('can-add');
            }
        });
    }
    
    function addToTimetable(subjectId, day, period, location) {
        console.log('addToTimetable í•¨ìˆ˜ í˜¸ì¶œë¨:', {
            subjectId: subjectId,
            day: day,
            period: period,
            location: location
        });
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('CSRF í† í°:', csrfToken);
        
        const requestBody = `subject_id=${subjectId}&day=${day}&period=${period}&location=${encodeURIComponent(location)}`;
        console.log('ìš”ì²­ ë³¸ë¬¸:', requestBody);
        
        fetch('{% url "timetable:add_to_timetable" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: requestBody
        })
        .then(response => {
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ì„œë²„ ì‘ë‹µ:', data);
            if (data.success) {
                alert(data.message || 'ê³¼ëª©ì´ ì‹œê°„í‘œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì‹œê°„í‘œ ìë™ ì—…ë°ì´íŠ¸
                updateTimetableDisplay();
            } else {
                alert(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        });
    }
    
    // ì‹œê°„í‘œ ìë™ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
    function updateTimetableDisplay() {
        // AJAXë¡œ ì‹œê°„í‘œ ë°ì´í„°ë§Œ ê°€ì ¸ì™€ì„œ ì—…ë°ì´íŠ¸
        fetch('{% url "timetable:get_timetable_data" %}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ê¸°ì¡´ ì‹œê°„í‘œ ì…€ ì´ˆê¸°í™”
                document.querySelectorAll('.timetable-cell').forEach(cell => {
                    cell.innerHTML = '<button class="btn btn-outline-secondary btn-sm w-100 h-100" onclick="addToTimetable(\'' + cell.dataset.day + '\', ' + cell.dataset.period + ')">+</button>';
                });
                
                // ìƒˆë¡œìš´ ì‹œê°„í‘œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
                data.timetable_data.forEach(slot => {
                    const cell = document.querySelector(`[data-day="${slot.day}"][data-period="${slot.period}"]`);
                    if (cell) {
                        cell.innerHTML = `
                            <div class="subject-card" style="background-color: ${slot.subject_color}; color: white; padding: 5px; border-radius: 3px; position: relative;">
                                <strong>${slot.subject_name}</strong>
                                <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0" 
                                        onclick="removeFromTimetable('${slot.day}', ${slot.period})" 
                                        style="padding: 1px 4px; font-size: 10px;">Ã—</button>
                            </div>
                        `;
                    }
                });
            } else {
                console.error('ì‹œê°„í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => {
            console.error('ì‹œê°„í‘œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë§Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
        });
    }
    
    function removeFromTimetable(day, period) {
        if (!confirm('ì´ ì‹œê°„í‘œ ìŠ¬ë¡¯ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
        
        fetch('{% url "timetable:remove_from_timetable" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `day=${day}&period=${period}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTimetableDisplay(); // ì‹œê°„í‘œ ìë™ ì—…ë°ì´íŠ¸
            } else {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
});
</script>

{% csrf_token %}
{% endblock %}
