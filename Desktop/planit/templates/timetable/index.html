{% extends 'base.html' %}
{% load static %}
{% load timetable_extras %}

{% block title %}ì‹œê°„í‘œ - PlanIt{% endblock %}

{% block extra_css %}
<style>
.timetable-grid {
    min-width: 800px;
    table-layout: fixed !important;
    width: 100% !important;
}

.timetable-grid tbody tr {
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
    line-height: normal !important;
}

.timetable-grid tbody tr td {
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
}

.timetable-cell {
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
    border: 1px solid #E5E5EA;
    position: relative;
    vertical-align: middle !important;
    padding: 2px !important;
    background-color: white;
}

.timetable-header {
    background-color: #F2F2F7;
    font-weight: 600;
    text-align: center;
    color: #636366;
    font-size: 0.9375rem;
}

.timetable-time {
    background-color: #F2F2F7;
    font-weight: 500;
    text-align: center;
    font-size: 0.875rem;
    color: #636366;
    width: 100px !important;
    min-width: 100px !important;
    max-width: 100px !important;
    height: 60px !important;
    min-height: 60px !important;
    max-height: 60px !important;
    vertical-align: middle !important;
    padding: 4px !important;
    line-height: 1.2 !important;
}

.subject-block {
    position: absolute;
    top: 2px;
    left: 2px;
    right: 2px;
    bottom: 2px;
    border-radius: 4px;
    padding: 4px 6px;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    overflow: hidden !important;
}

.subject-block:hover {
    opacity: 0.8;
}

.subject-name {
    font-weight: 600;
    margin-bottom: 1px;
}

.subject-location {
    font-size: 0.7rem;
    opacity: 0.9;
}

.empty-slot {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100% !important;
    min-height: 100% !important;
    max-height: 100% !important;
}

.empty-slot:hover {
    background-color: #e9ecef;
    border-color: #007bff;
}

.empty-slot i {
    font-size: 1.2rem;
    color: #6c757d;
}

.empty-slot:hover i {
    color: #007bff;
}

.semester-info {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-calendar-alt me-2"></i>ì‹œê°„í‘œ</h2>
            {% if current_semester %}
            <small class="text-muted">{{ current_semester }}</small>
            {% endif %}
        </div>
        <div class="btn-group">
            <div class="dropdown me-1">
                <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-camera me-2"></i>ì´ë¯¸ì§€ ì €ì¥
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="#" onclick="downloadTimetableImage('standard'); return false;">
                            <i class="fas fa-desktop me-2"></i>ê¸°ë³¸ ì €ì¥
                            <small class="text-muted d-block">í˜„ì¬ í™”ë©´ ê·¸ëŒ€ë¡œ</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="downloadTimetableImage('wallpaper'); return false;">
                            <i class="fas fa-mobile-alt me-2"></i>ìŠ¤ë§ˆíŠ¸í° ë°°ê²½í™”ë©´
                            <small class="text-muted d-block">ì„¸ë¡œë¡œ ê¸¸ê²Œ (9:16)</small>
                        </a>
                    </li>
                </ul>
            </div>
            <a href="{% url 'timetable:subject_list' %}" class="btn btn-primary">
                <i class="fas fa-book me-2"></i>ê³¼ëª© ê´€ë¦¬
            </a>
            <a href="{% url 'timetable:timetable_manage' %}" class="btn btn-success">
                <i class="fas fa-edit me-2"></i>ì‹œê°„í‘œ í¸ì§‘
            </a>
            <a href="{% url 'timetable:semester_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-cog me-2"></i>í•™ê¸° ê´€ë¦¬
            </a>
        </div>
    </div>

    <!-- í•™ê¸° ì„ íƒ ë° í˜„ì¬ í•™ê¸° ì •ë³´ -->
    <div class="semester-info">
        <div class="row align-items-center">
            <div class="col-md-6">
                {% if current_semester %}
                <h5 class="mb-1"><i class="fas fa-graduation-cap me-2"></i>{{ current_semester }}</h5>
                <p class="mb-0 opacity-75">{{ current_semester.start_date }} ~ {{ current_semester.end_date }}</p>
                {% else %}
                <h5 class="mb-1"><i class="fas fa-exclamation-triangle me-2"></i>í•™ê¸° ë¯¸ì„¤ì •</h5>
                <p class="mb-0 opacity-75">í•™ê¸°ë¥¼ ì„¤ì •í•˜ì—¬ ì‹œê°„í‘œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
                {% endif %}
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex align-items-center justify-content-md-end gap-2 mt-2 mt-md-0">
                    <span class="badge bg-light text-dark fs-6">ì´ {{ semester_subjects_count }}ê°œ ê³¼ëª©</span>
                    {% if all_semesters %}
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-exchange-alt me-1"></i>í•™ê¸° ì „í™˜
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% for semester in all_semesters %}
                            <li>
                                <a class="dropdown-item {% if current_semester.id == semester.id %}active{% endif %}" 
                                   href="?semester={{ semester.id }}">
                                    <i class="fas fa-{% if semester.is_current %}star text-warning{% else %}calendar{% endif %} me-2"></i>
                                    {{ semester }}
                                    {% if semester.is_current %}<span class="badge bg-success ms-2">í˜„ì¬</span>{% endif %}
                                </a>
                            </li>
                            {% endfor %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-primary" href="{% url 'timetable:semester_create' %}">
                                    <i class="fas fa-plus me-2"></i>ìƒˆ í•™ê¸° ì¶”ê°€
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% else %}
                    <a href="{% url 'timetable:semester_create' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-plus me-1"></i>ìƒˆ í•™ê¸° ì¶”ê°€
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹œê°„í‘œ -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0 timetable-grid">
                    <thead>
                        <tr>
                            <th class="timetable-header" style="width: 100px;">êµì‹œ</th>
                            {% for day in days %}
                            <th class="timetable-header">{{ day_names|lookup:day }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for period in periods %}
                        <tr>
                            <td class="timetable-time">
                                <div>{{ period }}êµì‹œ</div>
                                <small class="text-muted">
                                    {% if period == 1 %}08:10-09:00
                                    {% elif period == 2 %}09:10-10:00
                                    {% elif period == 3 %}10:10-11:00
                                    {% elif period == 4 %}11:10-12:00
                                    {% elif period == 5 %}13:00-13:50
                                    {% elif period == 6 %}14:00-14:50
                                    {% elif period == 7 %}15:10-16:00
                                    {% elif period == 8 %}16:10-17:00
                                    {% endif %}
                                </small>
                            </td>
                            {% for day in days %}
                            <td class="timetable-cell">
                                {% with slot_data=timetable_data|lookup:day|lookup:period %}
                                {% if slot_data %}
                                    <div class="subject-block" 
                                         style="background-color: {{ slot_data.subject.color }};"
                                         onclick="showSubjectDetail('{{ slot_data.subject.id }}')"
                                         data-bs-toggle="tooltip"
                                         title="{{ slot_data.subject.name }} - {{ slot_data.subject.professor }}">
                                        <div class="subject-name">{{ slot_data.subject.name }}</div>
                                        {% if slot_data.subject.professor or slot_data.subject.classroom %}
                                        <div class="subject-location">
                                            {{ slot_data.subject.professor }}{% if slot_data.subject.professor and slot_data.subject.classroom %} Â· {% endif %}{{ slot_data.subject.classroom }}
                                        </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="empty-slot h-100 d-flex align-items-center justify-content-center"
                                         onclick="goToTimetableManage()"
                                         style="cursor: pointer;"
                                         data-bs-toggle="tooltip"
                                         title="ì‹œê°„í‘œ ê´€ë¦¬ë¡œ ì´ë™">
                                        <i class="fas fa-plus text-muted"></i>
                                    </div>
                                {% endif %}
                                {% endwith %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ê³¼ëª© ëª©ë¡ -->
    {% if semester_subjects %}
    <div class="row mt-4">
        <div class="col-12">
            <h4><i class="fas fa-list me-2"></i>ë“±ë¡ëœ ê³¼ëª©</h4>
            <div class="row g-3">
                {% for subject in semester_subjects %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-start justify-content-between mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        <span class="badge me-2" style="background-color: {{ subject.color }};">&nbsp;</span>
                                        {{ subject.name }}
                                    </h6>
                                    <p class="card-text small text-muted mb-2">
                                        <i class="fas fa-user-tie me-1"></i>{{ subject.professor|default:"ë¯¸ì •" }}
                                        <span class="mx-2">|</span>
                                        <i class="fas fa-star me-1"></i>{{ subject.credits }}í•™ì 
                                    </p>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'timetable:subject_detail' subject.id %}">
                                            <i class="fas fa-eye me-2"></i>ìƒì„¸ë³´ê¸°
                                        </a></li>
                                        <li><a class="dropdown-item" href="{% url 'timetable:subject_edit' subject.id %}">
                                            <i class="fas fa-edit me-2"></i>ìˆ˜ì •
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="{% url 'timetable:subject_delete' subject.id %}">
                                            <i class="fas fa-trash me-2"></i>ì‚­ì œ
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="small">
                                <span class="badge bg-secondary">{{ subject.get_subject_type_display }}</span>
                                <span class="badge bg-info">{{ subject.get_evaluation_type_display }}</span>
                            </div>
                            {% if subject.time_slots.all %}
                            <div class="mt-2 small text-muted">
                                {% for time_slot in subject.time_slots.all %}
                                <span class="badge bg-light text-dark me-1">
                                    {{ time_slot.get_day_display }} {{ time_slot.period }}êµì‹œ
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
        <h5>ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤</h5>
        <p class="text-muted">ìƒˆ ê³¼ëª©ì„ ì¶”ê°€í•˜ì—¬ ì‹œê°„í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
        <a href="{% url 'timetable:subject_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>ì²« ë²ˆì§¸ ê³¼ëª© ì¶”ê°€í•˜ê¸°
        </a>
    </div>
    {% endif %}
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// í…œí”Œë¦¿ í•„í„° ëŒ€ì‹  ì‚¬ìš©í•  JavaScript í•¨ìˆ˜
function lookup(obj, key) {
    return obj[key];
}

// ê³¼ëª© ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
function showSubjectDetail(subjectId) {
    window.location.href = `/timetable/subject/${subjectId}/`;
}

// ì‹œê°„í‘œ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
function goToTimetableManage() {
    console.log('ì‹œê°„í‘œ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...');
    window.location.href = '/timetable/manage/';
}

// ì‹œê°„í‘œ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
function downloadTimetableImage(mode = 'standard') {
    if (mode === 'wallpaper') {
        downloadWallpaperImage();
        return;
    }
    
    const timetableCard = document.querySelector('.timetable-grid').closest('.card');
    const btn = document.querySelector('.dropdown-toggle.btn-info');
    const originalText = btn.innerHTML;
    
    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ìƒì„± ì¤‘...';
    btn.disabled = true;
    
    // ë¹ˆ ìŠ¬ë¡¯ ìˆ¨ê¸°ê¸° (ì´ë¯¸ì§€ì—ì„œ + ì•„ì´ì½˜ ì•ˆ ë³´ì´ê²Œ)
    const emptySlots = document.querySelectorAll('.empty-slot');
    emptySlots.forEach(slot => {
        slot.style.visibility = 'hidden';
    });
    
    html2canvas(timetableCard, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false,
        onclone: function(clonedDoc) {
            // í´ë¡ ëœ ë¬¸ì„œì—ì„œ ìŠ¤íƒ€ì¼ ì¡°ì •
            const clonedCard = clonedDoc.querySelector('.card');
            if (clonedCard) {
                clonedCard.style.boxShadow = 'none';
            }
        }
    }).then(canvas => {
        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        const semester = '{{ current_semester|default:"ì‹œê°„í‘œ" }}';
        const date = new Date().toISOString().slice(0, 10);
        link.download = `PlanIt_${semester}_${date}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // ë¹ˆ ìŠ¬ë¡¯ ë‹¤ì‹œ í‘œì‹œ
        emptySlots.forEach(slot => {
            slot.style.visibility = 'visible';
        });
        
        // ì„±ê³µ ë©”ì‹œì§€
        alert('ì‹œê°„í‘œ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(error => {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
        btn.innerHTML = originalText;
        btn.disabled = false;
        emptySlots.forEach(slot => {
            slot.style.visibility = 'visible';
        });
        alert('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ìŠ¤ë§ˆíŠ¸í° ë°°ê²½í™”ë©´ìš© ì„¸ë¡œ ì´ë¯¸ì§€ ìƒì„±
function downloadWallpaperImage() {
    const btn = document.querySelector('.dropdown-toggle.btn-info');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ìƒì„± ì¤‘...';
    btn.disabled = true;
    
    // ì‹œê°„í‘œ ë°ì´í„° ìˆ˜ì§‘
    const subjects = [];
    document.querySelectorAll('.subject-block').forEach(block => {
        const name = block.querySelector('.subject-name')?.textContent || '';
        const location = block.querySelector('.subject-location')?.textContent || '';
        const color = block.style.backgroundColor;
        const cell = block.closest('td');
        const row = cell.closest('tr');
        const rowIndex = row.rowIndex; // 1ë¶€í„° ì‹œì‘ (í—¤ë” ì œì™¸)
        const cellIndex = cell.cellIndex; // 0ì€ êµì‹œ, 1ë¶€í„° ìš”ì¼
        
        subjects.push({
            name: name.trim(),
            location: location.trim(),
            color: color,
            period: rowIndex,
            day: cellIndex
        });
    });
    
    // ìº”ë²„ìŠ¤ ìƒì„± (9:16 ë¹„ìœ¨, ìŠ¤ë§ˆíŠ¸í° ë°°ê²½í™”ë©´ìš©)
    const canvas = document.createElement('canvas');
    const width = 1080;
    const height = 1920;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    
    // ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#667eea');
    gradient.addColorStop(0.5, '#764ba2');
    gradient.addColorStop(1, '#f093fb');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // ìƒë‹¨ ì—¬ë°± (ì‹œê³„ ì˜ì—­)
    const topMargin = 280;
    
    // íƒ€ì´í‹€
    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
    ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“š ë‚´ ì‹œê°„í‘œ', width / 2, topMargin);
    
    // í•™ê¸° ì •ë³´
    const semester = '{{ current_semester|default:"" }}';
    if (semester) {
        ctx.font = '28px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.fillText(semester, width / 2, topMargin + 50);
    }
    
    // ì‹œê°„í‘œ í…Œì´ë¸” ì˜ì—­
    const tableTop = topMargin + 100;
    const tableLeft = 40;
    const tableWidth = width - 80;
    const dayWidth = (tableWidth - 80) / 5; // 5ì¼
    const periodHeight = 150; // ê° êµì‹œ ë†’ì´
    const headerHeight = 50;
    const timeColWidth = 80;
    
    // í…Œì´ë¸” ë°°ê²½
    ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
    roundRect(ctx, tableLeft, tableTop, tableWidth, headerHeight + periodHeight * 8 + 20, 20);
    ctx.fill();
    
    // ìš”ì¼ í—¤ë”
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
    ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.textAlign = 'center';
    days.forEach((day, i) => {
        const x = tableLeft + timeColWidth + dayWidth * i + dayWidth / 2;
        ctx.fillText(day, x, tableTop + 35);
    });
    
    // êµì‹œ ë° ì‹œê°„í‘œ ê·¸ë¦¬ê¸°
    const periods = [
        { p: 1, t: '08:10' },
        { p: 2, t: '09:10' },
        { p: 3, t: '10:10' },
        { p: 4, t: '11:10' },
        { p: 5, t: '13:00' },
        { p: 6, t: '14:00' },
        { p: 7, t: '15:10' },
        { p: 8, t: '16:10' }
    ];
    
    periods.forEach((period, i) => {
        const y = tableTop + headerHeight + periodHeight * i;
        
        // êµì‹œ ë²ˆí˜¸
        ctx.font = 'bold 20px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.textAlign = 'center';
        ctx.fillText(period.p + 'êµì‹œ', tableLeft + timeColWidth / 2, y + 50);
        
        // ì‹œê°„
        ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.fillText(period.t, tableLeft + timeColWidth / 2, y + 75);
        
        // êµ¬ë¶„ì„ 
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(tableLeft + 20, y + periodHeight);
        ctx.lineTo(tableLeft + tableWidth - 20, y + periodHeight);
        ctx.stroke();
    });
    
    // ê³¼ëª© ë¸”ë¡ ê·¸ë¦¬ê¸°
    subjects.forEach(subject => {
        const dayIndex = subject.day - 1; // 0-indexed
        const periodIndex = subject.period - 1; // 0-indexed
        
        if (dayIndex >= 0 && dayIndex < 5 && periodIndex >= 0 && periodIndex < 8) {
            const x = tableLeft + timeColWidth + dayWidth * dayIndex + 5;
            const y = tableTop + headerHeight + periodHeight * periodIndex + 10;
            const blockWidth = dayWidth - 10;
            const blockHeight = periodHeight - 20;
            
            // ê³¼ëª© ë¸”ë¡ ë°°ê²½
            ctx.fillStyle = subject.color || '#007bff';
            roundRect(ctx, x, y, blockWidth, blockHeight, 12);
            ctx.fill();
            
            // ê³¼ëª©ëª…
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
            ctx.textAlign = 'center';
            
            // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            const maxWidth = blockWidth - 16;
            const words = subject.name.split('');
            let line = '';
            let lineY = y + 45;
            
            if (ctx.measureText(subject.name).width > maxWidth) {
                // ê¸´ ì´ë¦„ì€ ì¤„ë°”ê¿ˆ
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                        ctx.fillText(line, x + blockWidth / 2, lineY);
                        line = words[n];
                        lineY += 24;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x + blockWidth / 2, lineY);
            } else {
                ctx.fillText(subject.name, x + blockWidth / 2, lineY);
            }
            
            // ì¥ì†Œ
            if (subject.location) {
                ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
                ctx.fillText(subject.location, x + blockWidth / 2, y + blockHeight - 20);
            }
        }
    });
    
    // í•˜ë‹¨ ë¸Œëœë”©
    ctx.font = '20px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.textAlign = 'center';
    ctx.fillText('PlanIt', width / 2, height - 80);
    
    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
    const link = document.createElement('a');
    const semesterName = '{{ current_semester|default:"ì‹œê°„í‘œ" }}';
    const date = new Date().toISOString().slice(0, 10);
    link.download = `PlanIt_${semesterName}_ë°°ê²½í™”ë©´_${date}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    // ë²„íŠ¼ ë³µì›
    btn.innerHTML = originalText;
    btn.disabled = false;
    
    alert('ìŠ¤ë§ˆíŠ¸í° ë°°ê²½í™”ë©´ìš© ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’¡ íŒ: ì ê¸ˆí™”ë©´ ë°°ê²½ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì–¸ì œë“  ì‹œê°„í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!');
}

// ë‘¥ê·¼ ì‚¬ê°í˜• ê·¸ë¦¬ê¸° í—¬í¼
function roundRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

document.addEventListener('DOMContentLoaded', function() {
    // íˆ´íŒ ì´ˆê¸°í™”
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
