{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}ìƒˆ ê¸€ ì‘ì„± - PlanIt{% endblock %}

{% block extra_css %}
<style>
.post-create-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.create-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border: none;
}

.create-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0;
    padding: 2rem;
    text-align: center;
}

.create-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: white;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
}

textarea.form-control {
    min-height: 200px;
    resize: vertical;
}

.btn-create {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.guide-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 15px;
    border: none;
    margin-top: 1.5rem;
}

.file-upload-area {
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    background: #f8fafc;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #667eea;
    background: #edf2f7;
}

.file-upload-area.dragover {
    border-color: #667eea;
    background: #e6fffa;
}
</style>
{% endblock %}

{% block content %}
<div class="post-create-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card create-card">
                    <div class="create-header">
                        <div class="create-icon">
                            <i class="fas fa-pen fa-2x"></i>
                        </div>
                        <h2 class="fw-bold mb-2">ìƒˆ ê¸€ ì‘ì„±</h2>
                        <p class="mb-0 opacity-90">ì»¤ë®¤ë‹ˆí‹°ì— ìƒˆë¡œìš´ ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data" id="postForm">
                            {% csrf_token %}
                            
                            <!-- ì¹´í…Œê³ ë¦¬ ë° ê²Œì‹œê¸€ ìœ í˜• -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_category" class="form-label">
                                            <i class="fas fa-folder text-primary"></i>
                                            ì¹´í…Œê³ ë¦¬
                                        </label>
                                        <select name="category" class="form-select" id="id_category" required>
                                            <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                            {% for category in categories %}
                                            <option value="{{ category.pk }}" 
                                                    data-icon="{{ category.icon }}" 
                                                    data-color="{{ category.color }}">
                                                {{ category.icon }} {{ category.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.category.errors %}
                                        <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.post_type.id_for_label }}" class="form-label">
                                            <i class="fas fa-tag text-success"></i>
                                            ê²Œì‹œê¸€ ìœ í˜•
                                        </label>
                                        <select name="post_type" class="form-select" id="id_post_type">
                                            {% for value, label in form.post_type.field.choices %}
                                            <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.post_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.post_type.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ì œëª© -->
                            <div class="form-group">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    <i class="fas fa-heading text-info"></i>
                                    ì œëª©
                                </label>
                                <input type="text" name="title" class="form-control" id="id_title" placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                                {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ê´€ë ¨ ê³¼ëª© -->
                            {% if form.subject.field.queryset %}
                            <div class="form-group">
                                <label for="{{ form.subject.id_for_label }}" class="form-label">
                                    <i class="fas fa-book text-warning"></i>
                                    ê´€ë ¨ ê³¼ëª© (ì„ íƒì‚¬í•­)
                                </label>
                                <select name="subject" class="form-select" id="id_subject">
                                    <option value="">ê³¼ëª© ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                                    {% for subject in form.subject.field.queryset %}
                                    <option value="{{ subject.pk }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.subject.errors %}
                                <div class="text-danger small mt-1">{{ form.subject.errors }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- íƒœê·¸ -->
                            <div class="form-group">
                                <label for="{{ form.tags_input.id_for_label }}" class="form-label">
                                    <i class="fas fa-hashtag text-purple"></i>
                                    íƒœê·¸ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="text" name="tags_input" class="form-control" id="id_tags_input" placeholder="íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í•™, íŒ)">
                                <small class="text-muted">ìµœëŒ€ 10ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                                {% if form.tags_input.errors %}
                                <div class="text-danger small mt-1">{{ form.tags_input.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ë‚´ìš© -->
                            <div class="form-group">
                                <label for="{{ form.content.id_for_label }}" class="form-label">
                                    <i class="fas fa-align-left text-secondary"></i>
                                    ë‚´ìš©
                                </label>
                                <textarea name="content" class="form-control" id="id_content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="10" required></textarea>
                                {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ì²¨ë¶€íŒŒì¼ -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-paperclip text-dark"></i>
                                    ì²¨ë¶€íŒŒì¼ (ì„ íƒì‚¬í•­)
                                </label>
                                <div class="file-upload-area" id="fileUploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-2">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                    <small class="text-muted">ìµœëŒ€ 5ê°œ íŒŒì¼, ê° íŒŒì¼ ìµœëŒ€ 10MB</small>
                                </div>
                                
                                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ë“¤ -->
                                <div id="fileInputsContainer" style="display: none;">
                                    <input type="file" name="attachments" id="fileInput0" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
                                    <input type="file" name="attachments" id="fileInput1" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
                                    <input type="file" name="attachments" id="fileInput2" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
                                    <input type="file" name="attachments" id="fileInput3" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
                                    <input type="file" name="attachments" id="fileInput4" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
                                </div>
                                
                                <!-- íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                                <div id="fileList" class="mt-2"></div>
                                
                                <!-- íŒŒì¼ ì¶”ê°€ ë²„íŠ¼ -->
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addFileBtn">
                                        <i class="fas fa-plus me-1"></i>íŒŒì¼ ì¶”ê°€
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2" id="clearFilesBtn" style="display: none;">
                                        <i class="fas fa-trash me-1"></i>ëª¨ë“  íŒŒì¼ ì œê±°
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ê³µì§€ì‚¬í•­ ì„¤ì • (ê´€ë¦¬ìë§Œ) -->
                            {% if user.is_staff %}
                            <div class="form-group">
                                <div class="form-check">
                                    {{ form.is_pinned }}
                                    <label class="form-check-label" for="{{ form.is_pinned.id_for_label }}">
                                        <i class="fas fa-thumbtack text-danger"></i>
                                        ê³µì§€ì‚¬í•­ìœ¼ë¡œ ì„¤ì •
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-create btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>ê²Œì‹œê¸€ ì‘ì„±
                                </button>
                            </div>
                        </form>
                        
                        <div class="text-center mt-4">
                            <a href="{% url 'community:post_list' %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                            </a>
                            <a href="{% url 'community:index' %}" class="btn btn-outline-info">
                                <i class="fas fa-home"></i> ì»¤ë®¤ë‹ˆí‹° í™ˆ
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- ì‘ì„± ê°€ì´ë“œ -->
                <div class="card guide-card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-lightbulb me-2"></i>ì‘ì„± ê°€ì´ë“œ
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-2">ğŸ“š ì¹´í…Œê³ ë¦¬ë³„ ê°€ì´ë“œ</h6>
                                <ul class="small mb-0">
                                    <li><strong>í•™ìŠµìë£Œ:</strong> ê°•ì˜ ìë£Œ, ìš”ì•½ ë…¸íŠ¸ ë“±</li>
                                    <li><strong>ì‹œí—˜ì •ë³´:</strong> ì‹œí—˜ ì¼ì •, ì¶œì œ ê²½í–¥ ë“±</li>
                                    <li><strong>ì²´ë ¥í‰ê°€:</strong> ìš´ë™ íŒ, í‰ê°€ ì •ë³´ ë“±</li>
                                    <li><strong>ììœ ê²Œì‹œíŒ:</strong> ììœ ë¡œìš´ ì†Œí†µ ê³µê°„</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-2">ğŸ’¡ ì‘ì„± íŒ</h6>
                                <ul class="small mb-0">
                                    <li>ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì œëª© ì‘ì„±</li>
                                    <li>ë‚´ìš©ì„ ë‹¨ë½ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±</li>
                                    <li>ê´€ë ¨ ìë£Œê°€ ìˆë‹¤ë©´ ì²¨ë¶€íŒŒì¼ í™œìš©</li>
                                    <li>ì ì ˆí•œ íƒœê·¸ë¡œ ê²€ìƒ‰ì„± í–¥ìƒ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('postForm');
    const titleField = document.getElementById('id_title');
    const contentField = document.getElementById('id_content');
    const categoryField = document.getElementById('id_category');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileList = document.getElementById('fileList');
    const addFileBtn = document.getElementById('addFileBtn');
    const clearFilesBtn = document.getElementById('clearFilesBtn');
    
    let selectedFiles = [];
    let fileInputIndex = 0;
    
    // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸
    if (fileUploadArea) {
        fileUploadArea.addEventListener('click', function() {
            addFile();
        });
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            addMultipleFiles(files);
        });
    }
    
    // íŒŒì¼ ì¶”ê°€ ë²„íŠ¼
    if (addFileBtn) {
        addFileBtn.addEventListener('click', function() {
            addFile();
        });
    }
    
    // ëª¨ë“  íŒŒì¼ ì œê±° ë²„íŠ¼
    if (clearFilesBtn) {
        clearFilesBtn.addEventListener('click', function() {
            clearAllFiles();
        });
    }
    
    function addFile() {
        if (selectedFiles.length >= 5) {
            alert('ìµœëŒ€ 5ê°œ íŒŒì¼ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        
        const fileInput = document.getElementById(`fileInput${fileInputIndex % 5}`);
        if (fileInput) {
            fileInput.click();
            fileInput.onchange = function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    if (validateFile(file)) {
                        selectedFiles.push({
                            file: file,
                            inputId: this.id
                        });
                        updateFileDisplay();
                        fileInputIndex++;
                    }
                }
            };
        }
    }
    
    function addMultipleFiles(files) {
        files.forEach(file => {
            if (selectedFiles.length >= 5) {
                alert('ìµœëŒ€ 5ê°œ íŒŒì¼ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (validateFile(file)) {
                const fileInput = document.getElementById(`fileInput${fileInputIndex % 5}`);
                if (fileInput) {
                    // DataTransferë¥¼ ì‚¬ìš©í•´ì„œ íŒŒì¼ì„ inputì— ì„¤ì •
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;
                    
                    selectedFiles.push({
                        file: file,
                        inputId: fileInput.id
                    });
                    fileInputIndex++;
                }
            }
        });
        updateFileDisplay();
    }
    
    function validateFile(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
            alert(`íŒŒì¼ "${file.name}"ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            return false;
        }
        
        const allowedTypes = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.txt', '.zip'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(fileExtension)) {
            alert(`íŒŒì¼ "${file.name}"ì€ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.`);
            return false;
        }
        
        return true;
    }
    
    function removeFile(index) {
        const fileData = selectedFiles[index];
        const fileInput = document.getElementById(fileData.inputId);
        if (fileInput) {
            fileInput.value = '';
        }
        
        selectedFiles.splice(index, 1);
        updateFileDisplay();
    }
    
    function clearAllFiles() {
        selectedFiles = [];
        for (let i = 0; i < 5; i++) {
            const fileInput = document.getElementById(`fileInput${i}`);
            if (fileInput) {
                fileInput.value = '';
            }
        }
        updateFileDisplay();
    }
    
    function updateFileDisplay() {
        if (!fileList) return;
        
        fileList.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            clearFilesBtn.style.display = 'none';
            return;
        }
        
        clearFilesBtn.style.display = 'inline-block';
        
        const listContainer = document.createElement('div');
        listContainer.className = 'mt-2';
        
        selectedFiles.forEach((fileData, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'alert alert-info alert-dismissible fade show d-flex align-items-center mb-2';
            fileItem.innerHTML = `
                <i class="fas fa-file me-2"></i>
                <span class="me-auto">${fileData.file.name} (${formatFileSize(fileData.file.size)})</span>
                <button type="button" class="btn-close" onclick="removeFileByIndex(${index})"></button>
            `;
            listContainer.appendChild(fileItem);
        });
        
        fileList.appendChild(listContainer);
    }
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ onclickì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡
    window.removeFileByIndex = function(index) {
        removeFile(index);
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // í¼ ê²€ì¦
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            let errorMessage = '';
            
            // ì¹´í…Œê³ ë¦¬ ê²€ì¦
            if (categoryField && !categoryField.value) {
                errorMessage = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                categoryField.focus();
                isValid = false;
            }
            // ì œëª© ê²€ì¦ (ë¹ˆ ê°’ë§Œ ì²´í¬)
            else if (titleField && titleField.value.trim().length === 0) {
                errorMessage = 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                titleField.focus();
                isValid = false;
            }
            // ë‚´ìš© ê²€ì¦
            else if (contentField && contentField.value.trim().length < 10) {
                errorMessage = 'ë‚´ìš©ì€ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                contentField.focus();
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
            }
        });
    }
});
</script>
{% endblock %}
