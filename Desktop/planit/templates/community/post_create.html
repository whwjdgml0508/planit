{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}ìƒˆ ê¸€ ì‘ì„± - PlanIt{% endblock %}

{% block extra_css %}
<style>
.post-create-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.create-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border: none;
}

.create-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0;
    padding: 2rem;
    text-align: center;
}

.create-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: white;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
}

textarea.form-control {
    min-height: 200px;
    resize: vertical;
}

.btn-create {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.guide-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 15px;
    border: none;
    margin-top: 1.5rem;
}

.file-upload-area {
    border: 3px dashed #cbd5e0;
    border-radius: 15px;
    padding: 3rem 2rem;
    text-align: center;
    background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.file-upload-area::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
    animation: pulse 3s ease-in-out infinite;
    pointer-events: none;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.file-upload-area.dragover {
    border-color: #667eea;
    background: linear-gradient(135deg, #e6fffa 0%, #d4f4ff 100%);
    transform: scale(1.02);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="post-create-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card create-card">
                    <div class="create-header">
                        <div class="create-icon">
                            <i class="fas fa-pen fa-2x"></i>
                        </div>
                        <h2 class="fw-bold mb-2">ìƒˆ ê¸€ ì‘ì„±</h2>
                        <p class="mb-0 opacity-90">ì»¤ë®¤ë‹ˆí‹°ì— ìƒˆë¡œìš´ ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data" id="postForm">
                            {% csrf_token %}
                            
                            <!-- ì¹´í…Œê³ ë¦¬ ë° ê²Œì‹œê¸€ ìœ í˜• -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_category" class="form-label">
                                            <i class="fas fa-folder text-primary"></i>
                                            ì¹´í…Œê³ ë¦¬
                                        </label>
                                        <select name="category" class="form-select" id="id_category" required>
                                            <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                            {% for category in categories %}
                                            <option value="{{ category.pk }}" 
                                                    data-icon="{{ category.icon }}" 
                                                    data-color="{{ category.color }}">
                                                {{ category.icon }} {{ category.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.category.errors %}
                                        <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.post_type.id_for_label }}" class="form-label">
                                            <i class="fas fa-tag text-success"></i>
                                            ê²Œì‹œê¸€ ìœ í˜•
                                        </label>
                                        <select name="post_type" class="form-select" id="id_post_type">
                                            {% for value, label in form.post_type.field.choices %}
                                            <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.post_type.errors %}
                                        <div class="text-danger small mt-1">{{ form.post_type.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ì œëª© -->
                            <div class="form-group">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    <i class="fas fa-heading text-info"></i>
                                    ì œëª©
                                </label>
                                <input type="text" name="title" class="form-control" id="id_title" placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                                {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ê´€ë ¨ ê³¼ëª© -->
                            {% if form.subject.field.queryset %}
                            <div class="form-group">
                                <label for="{{ form.subject.id_for_label }}" class="form-label">
                                    <i class="fas fa-book text-warning"></i>
                                    ê´€ë ¨ ê³¼ëª© (ì„ íƒì‚¬í•­)
                                </label>
                                <select name="subject" class="form-select" id="id_subject">
                                    <option value="">ê³¼ëª© ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                                    {% for subject in form.subject.field.queryset %}
                                    <option value="{{ subject.pk }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.subject.errors %}
                                <div class="text-danger small mt-1">{{ form.subject.errors }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- íƒœê·¸ -->
                            <div class="form-group">
                                <label for="{{ form.tags_input.id_for_label }}" class="form-label">
                                    <i class="fas fa-hashtag text-purple"></i>
                                    íƒœê·¸ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="text" name="tags_input" class="form-control" id="id_tags_input" placeholder="íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ìˆ˜í•™, íŒ)">
                                <small class="text-muted">ìµœëŒ€ 10ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                                {% if form.tags_input.errors %}
                                <div class="text-danger small mt-1">{{ form.tags_input.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ë‚´ìš© -->
                            <div class="form-group">
                                <label for="{{ form.content.id_for_label }}" class="form-label">
                                    <i class="fas fa-align-left text-secondary"></i>
                                    ë‚´ìš©
                                </label>
                                <textarea name="content" class="form-control" id="id_content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="10" required></textarea>
                                {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- ì²¨ë¶€íŒŒì¼ -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-paperclip text-dark"></i>
                                    ì²¨ë¶€íŒŒì¼ (ì„ íƒì‚¬í•­)
                                </label>
                                
                                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ input -->
                                <input type="file" id="fileInput" name="attachments" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.ppt,.pptx,.txt,.zip" multiple style="display: none;">
                                
                                <div class="file-upload-area" id="fileUploadArea" style="cursor: pointer;">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <p class="mb-2 fw-bold fs-5">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                    <small class="text-muted d-block mb-2">ìµœëŒ€ 5ê°œ íŒŒì¼, ê° íŒŒì¼ ìµœëŒ€ 10MB</small>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            ì´ë¯¸ì§€, PDF, ë¬¸ì„œ, ì••ì¶•íŒŒì¼ ì§€ì›
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                                <div id="fileList" class="mt-3"></div>
                                
                                <!-- íŒŒì¼ ê´€ë¦¬ ë²„íŠ¼ -->
                                <div class="mt-2 text-center" id="fileButtons" style="display: none;">
                                    <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllBtn">
                                        <i class="fas fa-trash me-1"></i>ëª¨ë“  íŒŒì¼ ì œê±°
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ê³µì§€ì‚¬í•­ ì„¤ì • (ê´€ë¦¬ìë§Œ) -->
                            {% if user.is_staff %}
                            <div class="form-group">
                                <div class="form-check">
                                    {{ form.is_pinned }}
                                    <label class="form-check-label" for="{{ form.is_pinned.id_for_label }}">
                                        <i class="fas fa-thumbtack text-danger"></i>
                                        ê³µì§€ì‚¬í•­ìœ¼ë¡œ ì„¤ì •
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-create btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>ê²Œì‹œê¸€ ì‘ì„±
                                </button>
                            </div>
                        </form>
                        
                        <div class="text-center mt-4">
                            <a href="{% url 'community:post_list' %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                            </a>
                            <a href="{% url 'community:index' %}" class="btn btn-outline-info">
                                <i class="fas fa-home"></i> ì»¤ë®¤ë‹ˆí‹° í™ˆ
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- ì‘ì„± ê°€ì´ë“œ -->
                <div class="card guide-card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-lightbulb me-2"></i>ì‘ì„± ê°€ì´ë“œ
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-2">ğŸ“š ì¹´í…Œê³ ë¦¬ë³„ ê°€ì´ë“œ</h6>
                                <ul class="small mb-0">
                                    <li><strong>í•™ìŠµìë£Œ:</strong> ê°•ì˜ ìë£Œ, ìš”ì•½ ë…¸íŠ¸ ë“±</li>
                                    <li><strong>ì‹œí—˜ì •ë³´:</strong> ì‹œí—˜ ì¼ì •, ì¶œì œ ê²½í–¥ ë“±</li>
                                    <li><strong>ì²´ë ¥í‰ê°€:</strong> ìš´ë™ íŒ, í‰ê°€ ì •ë³´ ë“±</li>
                                    <li><strong>ììœ ê²Œì‹œíŒ:</strong> ììœ ë¡œìš´ ì†Œí†µ ê³µê°„</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-2">ğŸ’¡ ì‘ì„± íŒ</h6>
                                <ul class="small mb-0">
                                    <li>ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì œëª© ì‘ì„±</li>
                                    <li>ë‚´ìš©ì„ ë‹¨ë½ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±</li>
                                    <li>íŒŒì¼ì€ ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì—…ë¡œë“œ (ìµœëŒ€ 5ê°œ)</li>
                                    <li>ì ì ˆí•œ íƒœê·¸ë¡œ ê²€ìƒ‰ì„± í–¥ìƒ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('postForm');
    const titleField = document.getElementById('id_title');
    const contentField = document.getElementById('id_content');
    const categoryField = document.getElementById('id_category');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileList = document.getElementById('fileList');
    const fileButtons = document.getElementById('fileButtons');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const fileInput = document.getElementById('fileInput');
    
    let selectedFiles = [];
    
    // í´ë¦­ ì´ë²¤íŠ¸ - íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    if (fileUploadArea) {
        fileUploadArea.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
    }
    
    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const chosenFiles = Array.from(e.target.files);
            if (chosenFiles.length > 0) {
                handleFiles(chosenFiles, false); // ê¸°ì¡´ íŒŒì¼ì— ì¶”ê°€
            }
        });
    }
    
    // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    if (fileUploadArea) {
        // ë“œë˜ê·¸ ì˜¤ë²„
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
            this.style.borderColor = '#667eea';
            this.style.backgroundColor = '#e6fffa';
        });
        
        // ë“œë˜ê·¸ ë¦¬ë¸Œ
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
            this.style.borderColor = '#cbd5e0';
            this.style.backgroundColor = '#f8fafc';
        });
        
        // ë“œë¡­
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
            this.style.borderColor = '#cbd5e0';
            this.style.backgroundColor = '#f8fafc';
            
            const droppedFiles = Array.from(e.dataTransfer.files);
            if (droppedFiles.length > 0) {
                handleFiles(droppedFiles, false); // ê¸°ì¡´ íŒŒì¼ì— ì¶”ê°€
            }
        });
    }
    
    // ëª¨ë‘ ì œê±° ë²„íŠ¼
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            selectedFiles = [];
            updateFileDisplay();
        });
    }
    
    function handleFiles(newFiles, replaceAll = false) {
        console.log('handleFiles called with', newFiles.length, 'files, replaceAll:', replaceAll);
        
        // replaceAllì´ trueë©´ ê¸°ì¡´ íŒŒì¼ ë¬´ì‹œ, falseë©´ í•©ì¹˜ê¸°
        const allFiles = replaceAll ? newFiles : [...selectedFiles, ...newFiles];
        
        // íŒŒì¼ ê°œìˆ˜ ì œí•œ
        if (allFiles.length > 5) {
            alert('ìµœëŒ€ 5ê°œ íŒŒì¼ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        
        // íŒŒì¼ ê²€ì¦
        let validFiles = [];
        for (let file of allFiles) {
            if (validateFile(file)) {
                validFiles.push(file);
            } else {
                return; // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
            }
        }
        
        selectedFiles = validFiles;
        console.log('Valid files:', selectedFiles.length);
        updateFileDisplay();
    }
    
    function validateFile(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
            alert(`íŒŒì¼ "${file.name}"ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            return false;
        }
        
        const allowedTypes = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.txt', '.zip'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(fileExtension)) {
            alert(`íŒŒì¼ "${file.name}"ì€ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.`);
            return false;
        }
        
        return true;
    }
    
    function updateFileDisplay() {
        if (!fileList) return;
        
        fileList.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            fileButtons.style.display = 'none';
            return;
        }
        
        fileButtons.style.display = 'block';
        
        const listContainer = document.createElement('div');
        listContainer.className = 'mt-2';
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'alert alert-info alert-dismissible fade show d-flex align-items-center mb-2';
            fileItem.innerHTML = `
                <i class="fas fa-file me-2"></i>
                <span class="me-auto">${file.name} (${formatFileSize(file.size)})</span>
                <button type="button" class="btn-close" data-index="${index}"></button>
            `;
            
            // ê°œë³„ íŒŒì¼ ì œê±°
            const closeBtn = fileItem.querySelector('.btn-close');
            closeBtn.addEventListener('click', function() {
                removeFile(parseInt(this.dataset.index));
            });
            
            listContainer.appendChild(fileItem);
        });
        
        fileList.appendChild(listContainer);
    }
    
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileDisplay();
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // í¼ ê²€ì¦ ë° ì œì¶œ
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
            
            let isValid = true;
            let errorMessage = '';
            
            // ì¹´í…Œê³ ë¦¬ ê²€ì¦
            if (categoryField && !categoryField.value) {
                errorMessage = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                categoryField.focus();
                isValid = false;
            }
            // ì œëª© ê²€ì¦ (ë¹ˆ ê°’ë§Œ ì²´í¬)
            else if (titleField && titleField.value.trim().length === 0) {
                errorMessage = 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                titleField.focus();
                isValid = false;
            }
            // ë‚´ìš© ê²€ì¦ (ë¹ˆ ê°’ë§Œ ì²´í¬)
            else if (contentField && contentField.value.trim().length === 0) {
                errorMessage = 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                contentField.focus();
                isValid = false;
            }
            
            if (!isValid) {
                alert(errorMessage);
                return;
            }
            
            // íŒŒì¼ì´ ìˆìœ¼ë©´ ìˆ¨ê²¨ì§„ inputì— íŒŒì¼ ì„¤ì •
            if (selectedFiles.length > 0 && fileInput) {
                const dt = new DataTransfer();
                selectedFiles.forEach(file => {
                    dt.items.add(file);
                });
                fileInput.files = dt.files;
                console.log('Form submitting with', fileInput.files.length, 'files');
            }
            
            // í¼ ì œì¶œ
            form.submit();
        });
    }
});
</script>
{% endblock %}
