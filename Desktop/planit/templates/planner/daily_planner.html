{% extends 'base.html' %}
{% load static %}
{% load planner_extras %}

{% block title %}ì¼ì¼ í”Œë˜ë„ˆ - {{ selected_date|date:"Yë…„ mì›” dì¼" }} - PlanIt{% endblock %}

{% block extra_css %}
<style>
.study-planner {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.planner-header {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.stat-card.green { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; }
.stat-card.cyan { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; }
.stat-card.red { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; }

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 5px;
}

.stat-progress {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-top: 5px;
    line-height: 1.2;
}

.main-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin-top: 20px;
}

.todo-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: fit-content;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.todo-input {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.todo-input input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}

.todo-input button {
    padding: 12px 20px;
    background: #4285f4;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

.todo-list {
    max-height: 400px;
    overflow-y: auto;
}

.todo-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

.todo-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.todo-item.completed {
    background: #f8f9fa;
    opacity: 0.7;
}

.todo-item.completed .todo-text {
    text-decoration: line-through;
    color: #6c757d;
}

.todo-checkbox {
    width: 18px;
    height: 18px;
    margin-right: 12px;
    cursor: pointer;
}

.todo-text {
    flex: 1;
    font-size: 14px;
}

.todo-delete {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.todo-delete:hover {
    background: #f8d7da;
}

.timer-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.timer-display {
    text-align: center;
    margin-bottom: 20px;
}

.timer-time {
    font-size: 3rem;
    font-weight: bold;
    color: #4285f4;
    margin-bottom: 10px;
}

.timer-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
}

.timer-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.timer-btn.start { background: #34a853; color: white; }
.timer-btn.pause { background: #fbbc04; color: white; }
.timer-btn.reset { background: #ea4335; color: white; }

.study-log {
    margin-top: 20px;
}

.log-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 14px;
}

.goal-section {
    background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    color: #2d3436;
}

.goal-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    min-height: 60px;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* ì‹œê°„í‘œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
.timetable-header {
    display: grid;
    grid-template-columns: 60px repeat(6, 1fr);
    gap: 1px;
    background: #495057;
    border-radius: 8px 8px 0 0;
    padding: 8px;
}

.timetable-header .time-label,
.timetable-header .minute-label {
    color: white;
    text-align: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.timetable-grid {
    border: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

.timetable-row {
    display: grid;
    grid-template-columns: 60px repeat(6, 1fr);
    gap: 1px;
    background: #dee2e6;
}

.hour-label {
    background: #6c757d;
    color: white;
    padding: 8px 4px;
    text-align: center;
    font-size: 0.7rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.time-cell {
    background: white;
    height: 25px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.time-cell:hover {
    background: #e9ecef;
    border-color: #007bff;
    transform: scale(1.05);
}

.time-cell.filled {
    opacity: 0.8;
    border-color: #0056b3 !important;
    box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
}

.time-cell.filled:hover {
    opacity: 1;
    transform: scale(1.05);
    box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
}

.study-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
}

.stat-value {
    font-weight: bold;
    color: #495057;
}

/* ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.save-btn-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

#manual-save-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

#manual-save-btn:hover {
    background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
}

#manual-save-btn:disabled {
    background: #6c757d;
    transform: none;
    box-shadow: none;
}

.section-save-btn {
    transition: all 0.2s ease;
}

.section-save-btn:hover {
    transform: translateY(-1px);
}

.save-success-animation {
    animation: saveSuccess 0.5s ease-in-out;
}

@keyframes saveSuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@media (max-width: 768px) {
    .stats-cards {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .main-content {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .timetable-header,
    .timetable-row {
        grid-template-columns: 50px repeat(6, 1fr);
    }
    
    .section-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .section-title .btn {
        align-self: stretch;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="study-planner">
    <div class="container">
        <!-- í—¤ë” -->
        <div class="planner-header">
            <div class="row align-items-center">
                <div class="col-2">
                    <button class="btn btn-light btn-sm" id="prev-day-btn">
                        <i class="fas fa-chevron-left"></i> ì´ì „
                    </button>
                </div>
                <div class="col-8 text-center">
                    <h2 class="mb-1">ğŸ“š í•™ìŠµ í”Œë˜ë„ˆ</h2>
                    <p class="mb-0" id="current-date">{{ selected_date|date:"Yë…„ mì›” dì¼ lìš”ì¼" }}</p>
                    <input type="date" class="form-control d-inline-block w-auto mt-2" id="date-picker" value="{{ selected_date|date:'Y-m-d' }}">
                    <div class="mt-2 d-flex align-items-center justify-content-center gap-3">
                        <button class="btn btn-success btn-sm" id="manual-save-btn">
                            <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
                        </button>
                        <div id="save-status" style="font-size: 0.8rem; color: #28a745;">
                            ğŸ’¾ ìë™ ì €ì¥ ì¤‘...
                        </div>
                    </div>
                </div>
                <div class="col-2 text-end">
                    <button class="btn btn-light btn-sm" id="next-day-btn">
                        ë‹¤ìŒ <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-cards">
            <div class="stat-card blue">
                <div class="stat-number">{{ stats.completed_todos }}/{{ stats.total_todos }}</div>
                <div class="stat-label">ì™„ë£Œí•œ í•  ì¼</div>
                <div class="stat-progress">
                    {% if stats.total_todos > 0 %}
                        {{ stats.completed_todos|percentage:stats.total_todos }}% ì™„ë£Œ
                    {% else %}
                        í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”
                    {% endif %}
                </div>
            </div>
            <div class="stat-card green">
                <div class="stat-number">{{ stats.study_hours|floatformat:1 }}h</div>
                <div class="stat-label">ì˜¤ëŠ˜ í•™ìŠµ ì‹œê°„</div>
                <div class="stat-progress">
                    ëª©í‘œ: {{ stats.target_hours }}h ({{ stats.achievement_rate }}%)
                </div>
            </div>
            <div class="stat-card cyan">
                <div class="stat-number">{{ stats.achievement_rate }}%</div>
                <div class="stat-label">ëª©í‘œ ë‹¬ì„±ë¥ </div>
                <div class="stat-progress">
                    {% if stats.achievement_rate >= 100 %}
                        ğŸ‰ ëª©í‘œ ë‹¬ì„±!
                    {% elif stats.achievement_rate >= 80 %}
                        ğŸ’ª ê±°ì˜ ë‹¤ ì™”ì–´ìš”!
                    {% elif stats.achievement_rate >= 50 %}
                        ğŸ“š ì—´ì‹¬íˆ í•˜ê³  ìˆì–´ìš”
                    {% else %}
                        ğŸš€ ì‹œì‘í•´ë´…ì‹œë‹¤!
                    {% endif %}
                </div>
            </div>
            <div class="stat-card {% if stats.overdue_tasks > 0 %}red{% else %}green{% endif %}">
                <div class="stat-number">{{ stats.overdue_tasks }}</div>
                <div class="stat-label">ë°€ë¦° ê³¼ì œ</div>
                <div class="stat-progress">
                    {% if stats.overdue_tasks > 0 %}
                        âš ï¸ í™•ì¸ í•„ìš”
                    {% else %}
                        âœ… ëª¨ë‘ ì™„ë£Œ
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ ëª©í‘œ -->
        <div class="goal-section">
            <div class="section-title">
                <span>ğŸ¯</span>
                <span>ì˜¤ëŠ˜ì˜ ëª©í‘œ</span>
            </div>
            <textarea class="goal-input" id="daily-goal" 
                      placeholder="ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ì ì–´ë³´ì„¸ìš”...">{{ daily_planner.daily_goal }}</textarea>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- ì¢Œì¸¡: í•  ì¼ ëª©ë¡ -->
            <div class="todo-section">
                <div class="section-title d-flex justify-content-between align-items-center">
                    <div>
                        <span>âœ…</span>
                        <span>ì˜¤ëŠ˜ì˜ í•  ì¼</span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm section-save-btn" id="save-todos-btn">
                        <i class="fas fa-save"></i> í•  ì¼ ì €ì¥
                    </button>
                </div>

                <!-- í•  ì¼ ì¶”ê°€ -->
                <div class="todo-input">
                    <input type="text" id="new-todo-title" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="add-todo-btn">ì¶”ê°€</button>
                </div>

                <!-- í•  ì¼ ëª©ë¡ -->
                <div class="todo-list">
                    {% for todo in todo_items %}
                    <div class="todo-item {% if todo.is_completed %}completed{% endif %}" data-todo-id="{{ todo.id }}">
                        <input type="checkbox" class="todo-checkbox" {% if todo.is_completed %}checked{% endif %}>
                        <span class="todo-text">{{ todo.title }}</span>
                        <button class="todo-delete delete-todo-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ìš°ì¸¡: ì‹œê°„í‘œ ê·¸ë¦¬ë“œ -->
            <div class="timer-section">
                <div class="section-title d-flex justify-content-between align-items-center">
                    <div>
                        <span>â°</span>
                        <span>10ë¶„ ë‹¨ìœ„ ì‹œê°„í‘œ</span>
                    </div>
                    <button class="btn btn-outline-success btn-sm section-save-btn" id="save-timetable-btn">
                        <i class="fas fa-save"></i> ì‹œê°„í‘œ ì €ì¥
                    </button>
                </div>
                
                <!-- ê³¼ëª© ì„ íƒ -->
                <div class="subject-selector mb-3">
                    <label for="subject-select" class="form-label">ê³¼ëª© ì„ íƒ:</label>
                    <select class="form-select" id="subject-select">
                        <option value="">ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" data-color="{{ subject.color|default:'#28a745' }}">
                            {{ subject.name }}
                        </option>
                        {% empty %}
                        <option value="default" data-color="#28a745">ê¸°ë³¸ ê³¼ëª©</option>
                        {% endfor %}
                    </select>
                    {% if not subjects %}
                    <small class="text-muted">
                        <a href="{% url 'timetable:index' %}" class="text-decoration-none">
                            <i class="fas fa-plus"></i> ì‹œê°„í‘œì—ì„œ ê³¼ëª©ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”
                        </a>
                    </small>
                    {% endif %}
                    
                    <!-- ì‚¬ìš©ë²• ì•ˆë‚´ -->
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            <strong>ì‚¬ìš©ë²•:</strong> 
                            ê³¼ëª© ì„ íƒ í›„ ì‹œê°„ ì¹¸ í´ë¦­ìœ¼ë¡œ ê¸°ë¡ | ë‹¤ì‹œ í´ë¦­ìœ¼ë¡œ ì‚­ì œ
                        </small>
                    </div>
                </div>
                
                <!-- ì‹œê°„í‘œ í—¤ë” -->
                <div class="timetable-header">
                    <div class="time-label">ì‹œê°„</div>
                    <div class="minute-label">00</div>
                    <div class="minute-label">10</div>
                    <div class="minute-label">20</div>
                    <div class="minute-label">30</div>
                    <div class="minute-label">40</div>
                    <div class="minute-label">50</div>
                </div>

                <!-- 10ë¶„ ë‹¨ìœ„ ì‹œê°„í‘œ ê·¸ë¦¬ë“œ -->
                <div class="timetable-grid">
                    <!-- 06:00 ~ 23:00 -->
                    <div class="timetable-row"><div class="hour-label">06:00</div><div class="time-cell" data-hour="06" data-minute="0"></div><div class="time-cell" data-hour="06" data-minute="1"></div><div class="time-cell" data-hour="06" data-minute="2"></div><div class="time-cell" data-hour="06" data-minute="3"></div><div class="time-cell" data-hour="06" data-minute="4"></div><div class="time-cell" data-hour="06" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">07:00</div><div class="time-cell" data-hour="07" data-minute="0"></div><div class="time-cell" data-hour="07" data-minute="1"></div><div class="time-cell" data-hour="07" data-minute="2"></div><div class="time-cell" data-hour="07" data-minute="3"></div><div class="time-cell" data-hour="07" data-minute="4"></div><div class="time-cell" data-hour="07" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">08:00</div><div class="time-cell" data-hour="08" data-minute="0"></div><div class="time-cell" data-hour="08" data-minute="1"></div><div class="time-cell" data-hour="08" data-minute="2"></div><div class="time-cell" data-hour="08" data-minute="3"></div><div class="time-cell" data-hour="08" data-minute="4"></div><div class="time-cell" data-hour="08" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">09:00</div><div class="time-cell" data-hour="09" data-minute="0"></div><div class="time-cell" data-hour="09" data-minute="1"></div><div class="time-cell" data-hour="09" data-minute="2"></div><div class="time-cell" data-hour="09" data-minute="3"></div><div class="time-cell" data-hour="09" data-minute="4"></div><div class="time-cell" data-hour="09" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">10:00</div><div class="time-cell" data-hour="10" data-minute="0"></div><div class="time-cell" data-hour="10" data-minute="1"></div><div class="time-cell" data-hour="10" data-minute="2"></div><div class="time-cell" data-hour="10" data-minute="3"></div><div class="time-cell" data-hour="10" data-minute="4"></div><div class="time-cell" data-hour="10" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">11:00</div><div class="time-cell" data-hour="11" data-minute="0"></div><div class="time-cell" data-hour="11" data-minute="1"></div><div class="time-cell" data-hour="11" data-minute="2"></div><div class="time-cell" data-hour="11" data-minute="3"></div><div class="time-cell" data-hour="11" data-minute="4"></div><div class="time-cell" data-hour="11" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">12:00</div><div class="time-cell" data-hour="12" data-minute="0"></div><div class="time-cell" data-hour="12" data-minute="1"></div><div class="time-cell" data-hour="12" data-minute="2"></div><div class="time-cell" data-hour="12" data-minute="3"></div><div class="time-cell" data-hour="12" data-minute="4"></div><div class="time-cell" data-hour="12" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">13:00</div><div class="time-cell" data-hour="13" data-minute="0"></div><div class="time-cell" data-hour="13" data-minute="1"></div><div class="time-cell" data-hour="13" data-minute="2"></div><div class="time-cell" data-hour="13" data-minute="3"></div><div class="time-cell" data-hour="13" data-minute="4"></div><div class="time-cell" data-hour="13" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">14:00</div><div class="time-cell" data-hour="14" data-minute="0"></div><div class="time-cell" data-hour="14" data-minute="1"></div><div class="time-cell" data-hour="14" data-minute="2"></div><div class="time-cell" data-hour="14" data-minute="3"></div><div class="time-cell" data-hour="14" data-minute="4"></div><div class="time-cell" data-hour="14" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">15:00</div><div class="time-cell" data-hour="15" data-minute="0"></div><div class="time-cell" data-hour="15" data-minute="1"></div><div class="time-cell" data-hour="15" data-minute="2"></div><div class="time-cell" data-hour="15" data-minute="3"></div><div class="time-cell" data-hour="15" data-minute="4"></div><div class="time-cell" data-hour="15" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">16:00</div><div class="time-cell" data-hour="16" data-minute="0"></div><div class="time-cell" data-hour="16" data-minute="1"></div><div class="time-cell" data-hour="16" data-minute="2"></div><div class="time-cell" data-hour="16" data-minute="3"></div><div class="time-cell" data-hour="16" data-minute="4"></div><div class="time-cell" data-hour="16" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">17:00</div><div class="time-cell" data-hour="17" data-minute="0"></div><div class="time-cell" data-hour="17" data-minute="1"></div><div class="time-cell" data-hour="17" data-minute="2"></div><div class="time-cell" data-hour="17" data-minute="3"></div><div class="time-cell" data-hour="17" data-minute="4"></div><div class="time-cell" data-hour="17" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">18:00</div><div class="time-cell" data-hour="18" data-minute="0"></div><div class="time-cell" data-hour="18" data-minute="1"></div><div class="time-cell" data-hour="18" data-minute="2"></div><div class="time-cell" data-hour="18" data-minute="3"></div><div class="time-cell" data-hour="18" data-minute="4"></div><div class="time-cell" data-hour="18" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">19:00</div><div class="time-cell" data-hour="19" data-minute="0"></div><div class="time-cell" data-hour="19" data-minute="1"></div><div class="time-cell" data-hour="19" data-minute="2"></div><div class="time-cell" data-hour="19" data-minute="3"></div><div class="time-cell" data-hour="19" data-minute="4"></div><div class="time-cell" data-hour="19" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">20:00</div><div class="time-cell" data-hour="20" data-minute="0"></div><div class="time-cell" data-hour="20" data-minute="1"></div><div class="time-cell" data-hour="20" data-minute="2"></div><div class="time-cell" data-hour="20" data-minute="3"></div><div class="time-cell" data-hour="20" data-minute="4"></div><div class="time-cell" data-hour="20" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">21:00</div><div class="time-cell" data-hour="21" data-minute="0"></div><div class="time-cell" data-hour="21" data-minute="1"></div><div class="time-cell" data-hour="21" data-minute="2"></div><div class="time-cell" data-hour="21" data-minute="3"></div><div class="time-cell" data-hour="21" data-minute="4"></div><div class="time-cell" data-hour="21" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">22:00</div><div class="time-cell" data-hour="22" data-minute="0"></div><div class="time-cell" data-hour="22" data-minute="1"></div><div class="time-cell" data-hour="22" data-minute="2"></div><div class="time-cell" data-hour="22" data-minute="3"></div><div class="time-cell" data-hour="22" data-minute="4"></div><div class="time-cell" data-hour="22" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">23:00</div><div class="time-cell" data-hour="23" data-minute="0"></div><div class="time-cell" data-hour="23" data-minute="1"></div><div class="time-cell" data-hour="23" data-minute="2"></div><div class="time-cell" data-hour="23" data-minute="3"></div><div class="time-cell" data-hour="23" data-minute="4"></div><div class="time-cell" data-hour="23" data-minute="5"></div></div>
                    
                    <!-- 00:00 ~ 05:00 (ë‹¤ìŒë‚ ) -->
                    <div class="timetable-row"><div class="hour-label">00:00</div><div class="time-cell" data-hour="00" data-minute="0"></div><div class="time-cell" data-hour="00" data-minute="1"></div><div class="time-cell" data-hour="00" data-minute="2"></div><div class="time-cell" data-hour="00" data-minute="3"></div><div class="time-cell" data-hour="00" data-minute="4"></div><div class="time-cell" data-hour="00" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">01:00</div><div class="time-cell" data-hour="01" data-minute="0"></div><div class="time-cell" data-hour="01" data-minute="1"></div><div class="time-cell" data-hour="01" data-minute="2"></div><div class="time-cell" data-hour="01" data-minute="3"></div><div class="time-cell" data-hour="01" data-minute="4"></div><div class="time-cell" data-hour="01" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">02:00</div><div class="time-cell" data-hour="02" data-minute="0"></div><div class="time-cell" data-hour="02" data-minute="1"></div><div class="time-cell" data-hour="02" data-minute="2"></div><div class="time-cell" data-hour="02" data-minute="3"></div><div class="time-cell" data-hour="02" data-minute="4"></div><div class="time-cell" data-hour="02" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">03:00</div><div class="time-cell" data-hour="03" data-minute="0"></div><div class="time-cell" data-hour="03" data-minute="1"></div><div class="time-cell" data-hour="03" data-minute="2"></div><div class="time-cell" data-hour="03" data-minute="3"></div><div class="time-cell" data-hour="03" data-minute="4"></div><div class="time-cell" data-hour="03" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">04:00</div><div class="time-cell" data-hour="04" data-minute="0"></div><div class="time-cell" data-hour="04" data-minute="1"></div><div class="time-cell" data-hour="04" data-minute="2"></div><div class="time-cell" data-hour="04" data-minute="3"></div><div class="time-cell" data-hour="04" data-minute="4"></div><div class="time-cell" data-hour="04" data-minute="5"></div></div>
                    <div class="timetable-row"><div class="hour-label">05:00</div><div class="time-cell" data-hour="05" data-minute="0"></div><div class="time-cell" data-hour="05" data-minute="1"></div><div class="time-cell" data-hour="05" data-minute="2"></div><div class="time-cell" data-hour="05" data-minute="3"></div><div class="time-cell" data-hour="05" data-minute="4"></div><div class="time-cell" data-hour="05" data-minute="5"></div></div>
                </div>

            </div>
        </div>
    </div>
</div>

{% csrf_token %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date('{{ selected_date|date:"Y-m-d" }}');
    
    // ë‚ ì§œ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function formatDateKorean(date) {
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const dayOfWeek = days[date.getDay()];
        return `${year}ë…„ ${month}ì›” ${day}ì¼ ${dayOfWeek}ìš”ì¼`;
    }
    
    function updateDateDisplay() {
        document.getElementById('current-date').textContent = formatDateKorean(currentDate);
        document.getElementById('date-picker').value = formatDate(currentDate);
    }
    
    // ë°ì´í„° ì €ì¥ í•¨ìˆ˜
    function saveData(showMessage = false) {
        try {
            const dateKey = formatDate(currentDate);
            
            // í•  ì¼ ëª©ë¡ ì €ì¥
            const todos = [];
            document.querySelectorAll('.todo-item').forEach(item => {
                const textElement = item.querySelector('.todo-text');
                if (textElement) {
                    const text = textElement.textContent;
                    const completed = item.classList.contains('completed');
                    todos.push({ text, completed });
                }
            });
            
            // ì‹œê°„í‘œ ë°ì´í„° ì €ì¥
            const timeBlocks = {};
            document.querySelectorAll('.time-cell.filled').forEach(cell => {
                const hour = cell.dataset.hour;
                const minute = cell.dataset.minute;
                const subject = cell.title.split(' - ')[1] || '';
                const color = cell.style.backgroundColor;
                timeBlocks[`${hour}-${minute}`] = { subject, color };
            });
            
            // ì¼ì¼ ëª©í‘œ ì €ì¥
            const dailyGoalElement = document.getElementById('daily-goal');
            const dailyGoal = dailyGoalElement ? dailyGoalElement.value : '';
            
            const data = {
                todos,
                timeBlocks,
                dailyGoal,
                date: dateKey,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(`planner-${dateKey}`, JSON.stringify(data));
            console.log('âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ:', dateKey, 'í• ì¼:', todos.length, 'ì‹œê°„ë¸”ë¡:', Object.keys(timeBlocks).length);
            
            // ì €ì¥ ìƒíƒœ í‘œì‹œ
            const saveStatus = document.getElementById('save-status');
            if (saveStatus) {
                if (showMessage) {
                    saveStatus.innerHTML = 'âœ… ìˆ˜ë™ ì €ì¥ ì™„ë£Œ!';
                    saveStatus.style.color = '#28a745';
                    saveStatus.style.fontWeight = 'bold';
                    setTimeout(() => {
                        saveStatus.innerHTML = 'ğŸ’¾ ìë™ ì €ì¥ ì¤‘...';
                        saveStatus.style.color = '#6c757d';
                        saveStatus.style.fontWeight = 'normal';
                    }, 3000);
                } else {
                    saveStatus.innerHTML = 'âœ… ì €ì¥ ì™„ë£Œ';
                    saveStatus.style.color = '#28a745';
                    setTimeout(() => {
                        saveStatus.innerHTML = 'ğŸ’¾ ìë™ ì €ì¥ ì¤‘...';
                        saveStatus.style.color = '#6c757d';
                    }, 2000);
                }
            }
            
            // ì €ì¥ í™•ì¸
            const saved = localStorage.getItem(`planner-${dateKey}`);
            if (!saved) {
                console.error('âŒ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨!');
                if (saveStatus) {
                    saveStatus.innerHTML = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                    saveStatus.style.color = '#dc3545';
                }
                if (showMessage) {
                    alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } else if (showMessage) {
                // ìˆ˜ë™ ì €ì¥ ì‹œì—ë§Œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successMsg.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                successMsg.innerHTML = `
                    <strong>ğŸ‰ ì €ì¥ ì™„ë£Œ!</strong><br>
                    â€¢ í•  ì¼: ${todos.length}ê°œ<br>
                    â€¢ ì‹œê°„í‘œ: ${Object.keys(timeBlocks).length}ê°œ ë¸”ë¡<br>
                    â€¢ ë‚ ì§œ: ${dateKey}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(successMsg);
                
                // 3ì´ˆ í›„ ìë™ ì œê±°
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);
            }
            
        } catch (error) {
            console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            if (showMessage) {
                alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
    }
    
    // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadData() {
        const dateKey = formatDate(currentDate);
        const savedData = localStorage.getItem(`planner-${dateKey}`);
        
        if (savedData) {
            const data = JSON.parse(savedData);
            
            // í•  ì¼ ëª©ë¡ ë¡œë“œ
            const todoList = document.querySelector('.todo-list');
            todoList.innerHTML = '';
            
            if (data.todos && data.todos.length > 0) {
                data.todos.forEach(todo => {
                    const todoItem = document.createElement('div');
                    todoItem.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                    todoItem.innerHTML = `
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''}>
                        <span class="todo-text">${todo.text}</span>
                        <button class="todo-delete delete-todo-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    todoList.appendChild(todoItem);
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
                attachTodoEventListeners();
            } else {
                todoList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
            }
            
            // ì‹œê°„í‘œ ë°ì´í„° ë¡œë“œ
            document.querySelectorAll('.time-cell').forEach(cell => {
                cell.classList.remove('filled');
                cell.style.backgroundColor = '';
                cell.title = '';
            });
            
            if (data.timeBlocks) {
                Object.keys(data.timeBlocks).forEach(key => {
                    const [hour, minute] = key.split('-');
                    const cell = document.querySelector(`[data-hour="${hour}"][data-minute="${minute}"]`);
                    if (cell) {
                        const blockData = data.timeBlocks[key];
                        cell.classList.add('filled');
                        cell.style.setProperty('background-color', blockData.color, 'important');
                        cell.title = `${hour}:${minute}0 - ${blockData.subject}`;
                    }
                });
            }
            
            // ì¼ì¼ ëª©í‘œ ë¡œë“œ
            const dailyGoalElement = document.getElementById('daily-goal');
            if (dailyGoalElement && data.dailyGoal) {
                dailyGoalElement.value = data.dailyGoal;
            }
            
            console.log('ë°ì´í„° ë¡œë“œë¨:', dateKey);
        } else {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            document.querySelector('.todo-list').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                </div>
            `;
            
            document.querySelectorAll('.time-cell').forEach(cell => {
                cell.classList.remove('filled');
                cell.style.backgroundColor = '';
                cell.title = '';
            });
            
            const dailyGoalElement = document.getElementById('daily-goal');
            if (dailyGoalElement) {
                dailyGoalElement.value = '';
            }
        }
        
        updateStudyStats();
        updateTodoStats();
    }
    
    // ì´ì „/ë‹¤ìŒ ë‚ ì§œ ë²„íŠ¼
    const prevBtn = document.getElementById('prev-day-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', function() {
            saveData(); // í˜„ì¬ ë°ì´í„° ì €ì¥
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateDisplay();
            loadData(); // ìƒˆ ë‚ ì§œ ë°ì´í„° ë¡œë“œ
        });
    }
    
    const nextBtn = document.getElementById('next-day-btn');
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            saveData(); // í˜„ì¬ ë°ì´í„° ì €ì¥
            currentDate.setDate(currentDate.getDate() + 1);
            updateDateDisplay();
            loadData(); // ìƒˆ ë‚ ì§œ ë°ì´í„° ë¡œë“œ
        });
    }
    
    // ë‚ ì§œ ì„ íƒê¸°
    const datePicker = document.getElementById('date-picker');
    if (datePicker) {
        datePicker.addEventListener('change', function() {
            saveData(); // í˜„ì¬ ë°ì´í„° ì €ì¥
            currentDate = new Date(this.value);
            updateDateDisplay();
            loadData(); // ìƒˆ ë‚ ì§œ ë°ì´í„° ë¡œë“œ
        });
    }
    
    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
    function updateTimerDisplay() {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        const timerDisplay = document.getElementById('timer-display');
        if (timerDisplay) {
            timerDisplay.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    // íƒ€ì´ë¨¸ ì‹œì‘
    const startBtn = document.getElementById('start-btn');
    if (startBtn) {
        startBtn.addEventListener('click', function() {
            if (!isRunning) {
                timerInterval = setInterval(function() {
                    seconds++;
                    updateTimerDisplay();
                }, 1000);
                isRunning = true;
                this.textContent = 'ì¼ì‹œì •ì§€';
                this.classList.remove('btn-success');
                this.classList.add('btn-warning');
            } else {
                clearInterval(timerInterval);
                isRunning = false;
                this.textContent = 'ì‹œì‘';
                this.classList.remove('btn-warning');
                this.classList.add('btn-success');
            }
        });
    }
    
    // íƒ€ì´ë¨¸ ë¦¬ì…‹
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            clearInterval(timerInterval);
            seconds = 0;
            isRunning = false;
            updateTimerDisplay();
            const startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.textContent = 'ì‹œì‘';
                startBtn.classList.remove('btn-warning');
                startBtn.classList.add('btn-success');
            }
        });
    }
    
    // í•  ì¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    function attachTodoEventListeners() {
        // í•  ì¼ ì²´í¬ë°•ìŠ¤ í† ê¸€
        document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
            checkbox.removeEventListener('change', handleTodoToggle); // ì¤‘ë³µ ë°©ì§€
            checkbox.addEventListener('change', handleTodoToggle);
        });
        
        // í•  ì¼ ì‚­ì œ
        document.querySelectorAll('.delete-todo-btn').forEach(btn => {
            btn.removeEventListener('click', handleTodoDelete); // ì¤‘ë³µ ë°©ì§€
            btn.addEventListener('click', handleTodoDelete);
        });
    }
    
    function handleTodoToggle() {
        const todoItem = this.closest('.todo-item');
        if (this.checked) {
            todoItem.classList.add('completed');
        } else {
            todoItem.classList.remove('completed');
        }
        updateTodoStats(); // í†µê³„ ì—…ë°ì´íŠ¸
        saveData(); // ë³€ê²½ì‚¬í•­ ì €ì¥
    }
    
    function handleTodoDelete() {
        if (!confirm('ì´ í•  ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const todoItem = this.closest('.todo-item');
        todoItem.remove();
        
        // í•  ì¼ì´ ëª¨ë‘ ì‚­ì œë˜ë©´ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        const todoList = document.querySelector('.todo-list');
        if (todoList.children.length === 0) {
            todoList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                </div>
            `;
        }
        updateTodoStats(); // í†µê³„ ì—…ë°ì´íŠ¸
        saveData(); // ë³€ê²½ì‚¬í•­ ì €ì¥
    }
    
    // í•  ì¼ ì¶”ê°€
    const addTodoBtn = document.getElementById('add-todo-btn');
    if (addTodoBtn) {
        addTodoBtn.addEventListener('click', function() {
            const titleInput = document.getElementById('new-todo-title');
            if (!titleInput) return;
            const title = titleInput.value.trim();
            
            if (!title) {
                alert('í•  ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const todoList = document.querySelector('.todo-list');
            const newTodo = document.createElement('div');
            newTodo.className = 'todo-item';
            newTodo.innerHTML = `
                <input type="checkbox" class="todo-checkbox">
                <span class="todo-text">${title}</span>
                <button class="todo-delete delete-todo-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
            const emptyState = todoList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            todoList.appendChild(newTodo);
            const todoInput = document.getElementById('new-todo-title');
            if (todoInput) {
                todoInput.value = '';
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            attachTodoEventListeners();
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateTodoStats();
            
            // ë°ì´í„° ì €ì¥
            saveData();
        });
    }
    
    // Enter í‚¤ë¡œ í•  ì¼ ì¶”ê°€
    const newTodoInput = document.getElementById('new-todo-title');
    if (newTodoInput) {
        newTodoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const addBtn = document.getElementById('add-todo-btn');
                if (addBtn) {
                    addBtn.click();
                }
            }
        });
    }
    
    
    // ê°„ë‹¨í•œ í´ë¦­ ë°©ì‹ ì‹œê°„í‘œ ê¸°ë¡
    function attachTimeTableEvents() {
        document.querySelectorAll('.time-cell').forEach(cell => {
            cell.addEventListener('click', function(e) {
                e.preventDefault();
                const hour = this.dataset.hour;
                const minute = this.dataset.minute;
                console.log(`í´ë¦­ëœ ì‹œê°„: ${hour}:${minute}`); // ë””ë²„ê¹…ìš©
                toggleTimeBlock(hour, minute);
            });
        });
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    attachTimeTableEvents();
    
    // ì¼ì¼ ëª©í‘œ ì—…ë°ì´íŠ¸
    const dailyGoalElement = document.getElementById('daily-goal');
    if (dailyGoalElement) {
        dailyGoalElement.addEventListener('blur', function() {
            saveData(); // ëª©í‘œ ë³€ê²½ ì‹œ ì €ì¥
        });
    }
    
    // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const manualSaveBtn = document.getElementById('manual-save-btn');
    if (manualSaveBtn) {
        manualSaveBtn.addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
            this.disabled = true;
            
            setTimeout(() => {
                saveData(true); // ìˆ˜ë™ ì €ì¥ ë©”ì‹œì§€ í‘œì‹œ
                this.innerHTML = '<i class="fas fa-save"></i> ì €ì¥í•˜ê¸°';
                this.disabled = false;
            }, 500);
        });
    }
    
    const saveTodosBtn = document.getElementById('save-todos-btn');
    if (saveTodosBtn) {
        saveTodosBtn.addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
            this.disabled = true;
            
            setTimeout(() => {
                saveData(true);
                this.innerHTML = '<i class="fas fa-save"></i> í•  ì¼ ì €ì¥';
                this.disabled = false;
            }, 500);
        });
    }
    
    const saveTimetableBtn = document.getElementById('save-timetable-btn');
    if (saveTimetableBtn) {
        saveTimetableBtn.addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
            this.disabled = true;
            
            setTimeout(() => {
                saveData(true);
                this.innerHTML = '<i class="fas fa-save"></i> ì‹œê°„í‘œ ì €ì¥';
                this.disabled = false;
            }, 500);
        });
    }
    
    // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‹œê°„ ë¸”ë¡ ë¡œë“œ
    function loadTimeBlocksFromDatabase() {
        {% if time_blocks %}
        console.log('ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‹œê°„ ë¸”ë¡ ë¡œë“œ ì¤‘...');
        {% for hour, blocks in time_blocks.items %}
            {% for minute_block, block in blocks.items %}
                {% if block %}
                const cell_{{ hour }}_{{ minute_block }} = document.querySelector('[data-hour="{{ hour }}"][data-minute="{{ minute_block }}"]');
                if (cell_{{ hour }}_{{ minute_block }}) {
                    cell_{{ hour }}_{{ minute_block }}.classList.add('filled');
                    cell_{{ hour }}_{{ minute_block }}.style.setProperty('background-color', '{{ block.color }}', 'important');
                    cell_{{ hour }}_{{ minute_block }}.title = '{{ hour }}:{{ minute_block }}0 - {% if block.subject %}{{ block.subject.name }}{% else %}í•™ìŠµ{% endif %}';
                }
                {% endif %}
            {% endfor %}
        {% endfor %}
        console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì‹œê°„ ë¸”ë¡ ë¡œë“œ ì™„ë£Œ');
        updateStudyStats();
        {% endif %}
    }
    
    // ì´ˆê¸° ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ
    loadTimeBlocksFromDatabase();
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadData();
    
    // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    attachTodoEventListeners();
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ë°ì´í„° ìë™ ì €ì¥
    window.addEventListener('beforeunload', function(e) {
        saveData();
        console.log('í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì €ì¥');
    });
    
    // í˜ì´ì§€ ìˆ¨ê¹€/í‘œì‹œ ì‹œì—ë„ ì €ì¥ (ëª¨ë°”ì¼ ëŒ€ì‘)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            saveData();
            console.log('í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ì €ì¥');
        } else {
            console.log('í˜ì´ì§€ ë‹¤ì‹œ í‘œì‹œë¨');
        }
    });
    
    // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ëŒ€ì‘ - í¬ì»¤ìŠ¤ ìƒì„ ë•Œ ì €ì¥
    window.addEventListener('blur', function() {
        saveData();
        console.log('í¬ì»¤ìŠ¤ ìƒìŒ ì‹œ ì €ì¥');
    });
    
    // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ í›„ ì €ì¥
    document.addEventListener('touchend', function() {
        setTimeout(() => saveData(), 500);
    });
    
    // ì£¼ê¸°ì  ìë™ ì €ì¥ (15ì´ˆë§ˆë‹¤ë¡œ ë‹¨ì¶•)
    setInterval(function() {
        saveData();
        console.log('â° ì£¼ê¸°ì  ìë™ ì €ì¥ ì™„ë£Œ');
    }, 15000);
    
    // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥
    document.addEventListener('input', function(e) {
        if (e.target.id === 'daily-goal' || e.target.id === 'new-todo-title') {
            setTimeout(() => saveData(), 1000); // 1ì´ˆ í›„ ì €ì¥
        }
    });
});

// ì‹œê°„ ë¸”ë¡ í† ê¸€ í•¨ìˆ˜
function toggleTimeBlock(hour, minute) {
    console.log(`toggleTimeBlock í˜¸ì¶œ: ${hour}:${minute}`);
    
    const cell = document.querySelector(`[data-hour="${hour}"][data-minute="${minute}"]`);
    console.log('ì°¾ì€ ì…€:', cell);
    
    const subjectSelect = document.getElementById('subject-select');
    const selectedSubject = subjectSelect.value;
    console.log('ì„ íƒëœ ê³¼ëª©:', selectedSubject);
    
    if (!selectedSubject) {
        alert('ë¨¼ì € ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }
    
    const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
    const subjectColor = selectedOption.dataset.color;
    const subjectName = selectedOption.text;
    console.log('ê³¼ëª© ìƒ‰ìƒ:', subjectColor, 'ê³¼ëª©ëª…:', subjectName);
    
    // í˜„ì¬ ë‚ ì§œ
    const currentDate = new Date(document.getElementById('date-picker').value);
    const dateKey = currentDate.getFullYear() + '-' + 
                   String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(currentDate.getDate()).padStart(2, '0');
    
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (cell.classList.contains('filled')) {
        // ì œê±° - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œ
        console.log('ì…€ ì œê±° ì¤‘...');
        
        fetch("{% url 'planner:remove_time_block' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'date': dateKey,
                'hour': hour,
                'minute_block': minute
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‹œê°„ ë¸”ë¡ ì‚­ì œ ì™„ë£Œ');
                cell.classList.remove('filled');
                cell.style.backgroundColor = '';
                cell.title = '';
                updateStudyStats();
                saveLocalStorage();
            } else {
                console.error('âŒ ì‹œê°„ ë¸”ë¡ ì‚­ì œ ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => {
            console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        });
        
    } else {
        // ì¶”ê°€ - ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        console.log('ì…€ ì¶”ê°€ ì¤‘...', subjectColor);
        
        fetch("{% url 'planner:add_time_block' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'date': dateKey,
                'hour': hour,
                'minute_block': minute,
                'block_type': 'STUDY',
                'subject_id': selectedSubject !== 'default' ? selectedSubject : '',
                'color': subjectColor
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ì— ì‹œê°„ ë¸”ë¡ ì €ì¥ ì™„ë£Œ');
                cell.classList.add('filled');
                cell.style.setProperty('background-color', subjectColor, 'important');
                cell.title = `${hour}:${minute}0 - ${subjectName}`;
                updateStudyStats();
                saveLocalStorage();
            } else {
                console.error('âŒ ì‹œê°„ ë¸”ë¡ ì €ì¥ ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => {
            console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        });
    }
}

// localStorageì— ì €ì¥í•˜ëŠ” ë³„ë„ í•¨ìˆ˜
function saveLocalStorage() {
    const currentDate = new Date(document.getElementById('date-picker').value);
    const dateKey = currentDate.getFullYear() + '-' + 
                   String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(currentDate.getDate()).padStart(2, '0');
    
    // ì‹œê°„í‘œ ë°ì´í„° ìˆ˜ì§‘
    const timeBlocks = {};
    document.querySelectorAll('.time-cell.filled').forEach(filledCell => {
        const h = filledCell.dataset.hour;
        const m = filledCell.dataset.minute;
        const subject = filledCell.title.split(' - ')[1] || '';
        const color = filledCell.style.backgroundColor;
        timeBlocks[`${h}-${m}`] = { subject, color };
    });
    
    // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì™€ì„œ ì‹œê°„í‘œë§Œ ì—…ë°ì´íŠ¸
    const existingData = JSON.parse(localStorage.getItem(`planner-${dateKey}`) || '{}');
    existingData.timeBlocks = timeBlocks;
    localStorage.setItem(`planner-${dateKey}`, JSON.stringify(existingData));
}

// í•™ìŠµ í†µê³„ ì—…ë°ì´íŠ¸ (10ë¶„ ë‹¨ìœ„)
function updateStudyStats() {
    const filledCells = document.querySelectorAll('.time-cell.filled');
    const studyMinutes = filledCells.length * 10;
    const studyHours = (studyMinutes / 60).toFixed(1);
    
    // í•™ìŠµ ì‹œê°„ ì¹´ë“œ ì—…ë°ì´íŠ¸
    const studyHoursCard = document.querySelector('.stat-card.green .stat-number');
    if (studyHoursCard) {
        studyHoursCard.textContent = `${studyHours}h`;
    }
    
    // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    const targetHours = parseFloat(document.querySelector('.stat-progress')?.textContent.match(/ëª©í‘œ: ([\d.]+)h/)?.[1] || 8);
    const achievementRate = Math.min(100, (studyHours / targetHours * 100)).toFixed(1);
    
    const achievementCard = document.querySelector('.stat-card.cyan .stat-number');
    const achievementProgress = document.querySelector('.stat-card.cyan .stat-progress');
    
    if (achievementCard) {
        achievementCard.textContent = `${achievementRate}%`;
    }
    
    if (achievementProgress) {
        let message = 'ğŸš€ ì‹œì‘í•´ë´…ì‹œë‹¤!';
        if (achievementRate >= 100) {
            message = 'ğŸ‰ ëª©í‘œ ë‹¬ì„±!';
        } else if (achievementRate >= 80) {
            message = 'ğŸ’ª ê±°ì˜ ë‹¤ ì™”ì–´ìš”!';
        } else if (achievementRate >= 50) {
            message = 'ğŸ“š ì—´ì‹¬íˆ í•˜ê³  ìˆì–´ìš”';
        }
        achievementProgress.textContent = message;
    }
    
    // í•™ìŠµ ì‹œê°„ ì¹´ë“œì˜ ëª©í‘œ ë‹¬ì„±ë¥ ë„ ì—…ë°ì´íŠ¸
    const studyProgress = document.querySelector('.stat-card.green .stat-progress');
    if (studyProgress) {
        studyProgress.textContent = `ëª©í‘œ: ${targetHours}h (${achievementRate}%)`;
    }
}

// í•  ì¼ í†µê³„ ì—…ë°ì´íŠ¸
function updateTodoStats() {
    const totalTodos = document.querySelectorAll('.todo-item').length;
    const completedTodos = document.querySelectorAll('.todo-item.completed').length;
    const percentage = totalTodos > 0 ? ((completedTodos / totalTodos) * 100).toFixed(1) : 0;
    
    const todoCard = document.querySelector('.stat-card.blue .stat-number');
    const todoProgress = document.querySelector('.stat-card.blue .stat-progress');
    
    if (todoCard) {
        todoCard.textContent = `${completedTodos}/${totalTodos}`;
    }
    
    if (todoProgress) {
        if (totalTodos > 0) {
            todoProgress.textContent = `${percentage}% ì™„ë£Œ`;
        } else {
            todoProgress.textContent = 'í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”';
        }
    }
}
</script>
{% endblock %}
