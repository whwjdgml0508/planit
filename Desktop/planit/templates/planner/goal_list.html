{% extends 'base.html' %}

{% block title %}목표 - PlanIt{% endblock %}

{% block extra_css %}
<style>
.progress-control {
    display: flex;
    align-items: center;
    gap: 10px;
}
.progress-control .btn {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
.progress-control .progress {
    flex: 1;
    height: 20px;
}
.progress-control .progress-text {
    min-width: 45px;
    text-align: center;
    font-weight: bold;
}

/* 하위 목표 스타일 */
.subgoal-section {
    margin-top: 15px;
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
}
.subgoal-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.subgoal-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.2s;
}
.subgoal-item:hover {
    background: #e9ecef;
}
.subgoal-item.completed {
    background: #d4edda;
}
.subgoal-item.completed .subgoal-title {
    text-decoration: line-through;
    color: #6c757d;
}
.subgoal-checkbox {
    width: 22px;
    height: 22px;
    margin-right: 12px;
    cursor: pointer;
    accent-color: #28a745;
}
.subgoal-title {
    flex: 1;
    font-size: 0.95rem;
}
.subgoal-delete {
    color: #dc3545;
    background: none;
    border: none;
    padding: 5px 8px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
}
.subgoal-item:hover .subgoal-delete {
    opacity: 0.6;
}
.subgoal-delete:hover {
    opacity: 1 !important;
}
.add-subgoal-form {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}
.add-subgoal-form input {
    flex: 1;
    font-size: 0.9rem;
}
.subgoal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.subgoal-counter {
    font-size: 0.85rem;
    color: #6c757d;
}
.custom-badge {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: #000;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-bullseye me-2"></i>목표</h2>
        <a href="{% url 'planner:goal_create' %}" class="btn btn-warning">
            <i class="fas fa-plus me-2"></i>새 목표 설정
        </a>
    </div>
    
    {% if goals %}
    <div class="row">
        {% for goal in goals %}
        <div class="col-md-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ goal.title }}</h5>
                    <span class="badge bg-secondary">{{ goal.get_goal_type_display }}</span>
                </div>
                <div class="card-body">
                    {% if goal.description %}
                    <p class="text-muted">{{ goal.description|truncatewords:20 }}</p>
                    {% endif %}
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            {{ goal.start_date }} ~ {{ goal.end_date }}
                        </small>
                    </div>
                    
                    <!-- 진행률 컨트롤 -->
                    <div class="mb-3">
                        <label class="form-label small text-muted mb-2">
                            <i class="fas fa-chart-line me-1"></i>진행률
                        </label>
                        <div class="progress-control" data-goal-id="{{ goal.pk }}">
                            <button type="button" class="btn btn-outline-secondary btn-decrease" title="10% 감소">
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="progress flex-grow-1">
                                <div class="progress-bar {% if goal.progress >= 100 %}bg-success{% elif goal.progress >= 50 %}bg-warning{% else %}bg-info{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ goal.progress }}%"
                                     aria-valuenow="{{ goal.progress }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <span class="progress-text">{{ goal.progress }}%</span>
                            <button type="button" class="btn btn-outline-primary btn-increase" title="10% 증가">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    {% if goal.memo %}
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted d-block mb-1"><i class="fas fa-sticky-note me-1"></i>메모</small>
                                <p class="mb-0" style="white-space: pre-wrap;">{{ goal.memo }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if goal.is_achieved %}
                    <div class="alert alert-success py-2 mb-0">
                        <i class="fas fa-trophy me-2"></i>목표 달성!
                        {% if goal.achievement_date %}
                        <br><small>{{ goal.achievement_date|date:"Y-m-d" }} 달성</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- 사용자 정의 목표: 하위 목표 섹션 -->
                    {% if goal.goal_type == 'CUSTOM' %}
                    <div class="subgoal-section" data-goal-id="{{ goal.pk }}">
                        <div class="subgoal-header">
                            <label class="form-label small text-muted mb-0">
                                <i class="fas fa-list-check me-1"></i>세부 목표
                            </label>
                            <span class="subgoal-counter">
                                <span class="completed-count">{{ goal.subgoals.all|length }}</span>개 중 
                                <span class="total-count">0</span>개 완료
                            </span>
                        </div>
                        
                        <ul class="subgoal-list">
                            {% for subgoal in goal.subgoals.all %}
                            <li class="subgoal-item {% if subgoal.is_completed %}completed{% endif %}" data-subgoal-id="{{ subgoal.pk }}">
                                <input type="checkbox" class="subgoal-checkbox" {% if subgoal.is_completed %}checked{% endif %}>
                                <span class="subgoal-title">{{ subgoal.title }}</span>
                                <button type="button" class="subgoal-delete" title="삭제">
                                    <i class="fas fa-times"></i>
                                </button>
                            </li>
                            {% empty %}
                            <li class="text-muted text-center py-2 no-subgoals">
                                <small>아직 세부 목표가 없습니다</small>
                            </li>
                            {% endfor %}
                        </ul>
                        
                        <div class="add-subgoal-form">
                            <input type="text" class="form-control form-control-sm new-subgoal-input" 
                                   placeholder="새 세부 목표 추가..." maxlength="200">
                            <button type="button" class="btn btn-sm btn-outline-primary add-subgoal-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <a href="{% url 'planner:goal_edit' goal.pk %}" class="btn btn-sm btn-outline-primary flex-fill">
                            <i class="fas fa-edit me-1"></i>수정
                        </a>
                        <a href="{% url 'planner:goal_delete' goal.pk %}" class="btn btn-sm btn-outline-danger flex-fill">
                            <i class="fas fa-trash me-1"></i>삭제
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
        <h5>설정된 목표가 없습니다</h5>
        <p class="text-muted">새로운 목표를 설정해보세요.</p>
        <a href="{% url 'planner:goal_create' %}" class="btn btn-warning">
            <i class="fas fa-plus me-2"></i>첫 번째 목표 설정하기
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 진행률 업데이트 함수
    function updateProgress(goalId, change) {
        const container = document.querySelector(`.progress-control[data-goal-id="${goalId}"]`);
        const progressBar = container.querySelector('.progress-bar');
        const progressText = container.querySelector('.progress-text');
        
        let currentProgress = parseInt(progressBar.getAttribute('aria-valuenow'));
        let newProgress = Math.max(0, Math.min(100, currentProgress + change));
        
        // AJAX 요청
        fetch(`/planner/ajax/update-goal-progress/${goalId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `progress=${newProgress}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // UI 업데이트
                progressBar.style.width = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressText.textContent = data.progress + '%';
                
                // 색상 업데이트
                progressBar.classList.remove('bg-info', 'bg-warning', 'bg-success');
                if (data.progress >= 100) {
                    progressBar.classList.add('bg-success');
                } else if (data.progress >= 50) {
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.add('bg-info');
                }
                
                // 100% 달성 시 페이지 새로고침
                if (data.is_achieved && data.progress >= 100) {
                    alert(data.message);
                    location.reload();
                }
            } else {
                alert('오류: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('네트워크 오류가 발생했습니다.');
        });
    }
    
    // 증가 버튼 이벤트
    document.querySelectorAll('.btn-increase').forEach(btn => {
        btn.addEventListener('click', function() {
            const goalId = this.closest('.progress-control').dataset.goalId;
            updateProgress(goalId, 10);
        });
    });
    
    // 감소 버튼 이벤트
    document.querySelectorAll('.btn-decrease').forEach(btn => {
        btn.addEventListener('click', function() {
            const goalId = this.closest('.progress-control').dataset.goalId;
            updateProgress(goalId, -10);
        });
    });
    
    // ==================== 하위 목표 관리 ====================
    
    // 하위 목표 카운터 업데이트
    function updateSubgoalCounter(section) {
        const items = section.querySelectorAll('.subgoal-item');
        const completedItems = section.querySelectorAll('.subgoal-item.completed');
        const totalCount = section.querySelector('.subgoal-counter .completed-count');
        const completedCount = section.querySelector('.subgoal-counter .total-count');
        
        if (totalCount) totalCount.textContent = items.length;
        if (completedCount) completedCount.textContent = completedItems.length;
    }
    
    // 진행률 바 업데이트
    function updateGoalProgressBar(goalId, progress, isAchieved) {
        const container = document.querySelector(`.progress-control[data-goal-id="${goalId}"]`);
        if (!container) return;
        
        const progressBar = container.querySelector('.progress-bar');
        const progressText = container.querySelector('.progress-text');
        
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = progress + '%';
        
        progressBar.classList.remove('bg-info', 'bg-warning', 'bg-success');
        if (progress >= 100) {
            progressBar.classList.add('bg-success');
        } else if (progress >= 50) {
            progressBar.classList.add('bg-warning');
        } else {
            progressBar.classList.add('bg-info');
        }
        
        if (isAchieved) {
            location.reload();
        }
    }
    
    // 하위 목표 체크박스 토글
    document.querySelectorAll('.subgoal-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.subgoal-item');
            const subgoalId = item.dataset.subgoalId;
            const section = this.closest('.subgoal-section');
            const goalId = section.dataset.goalId;
            
            fetch(`/planner/ajax/subgoals/${subgoalId}/toggle/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.is_completed) {
                        item.classList.add('completed');
                    } else {
                        item.classList.remove('completed');
                    }
                    updateSubgoalCounter(section);
                    updateGoalProgressBar(goalId, data.goal_progress, data.goal_is_achieved);
                    
                    if (data.message) {
                        alert(data.message);
                    }
                } else {
                    alert('오류: ' + data.error);
                    this.checked = !this.checked;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.checked = !this.checked;
            });
        });
    });
    
    // 하위 목표 삭제
    document.querySelectorAll('.subgoal-delete').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!confirm('이 세부 목표를 삭제하시겠습니까?')) return;
            
            const item = this.closest('.subgoal-item');
            const subgoalId = item.dataset.subgoalId;
            const section = this.closest('.subgoal-section');
            const goalId = section.dataset.goalId;
            
            fetch(`/planner/ajax/subgoals/${subgoalId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    item.remove();
                    updateSubgoalCounter(section);
                    updateGoalProgressBar(goalId, data.goal_progress, data.goal_is_achieved);
                    
                    // 하위 목표가 없으면 빈 메시지 표시
                    const list = section.querySelector('.subgoal-list');
                    if (list.querySelectorAll('.subgoal-item').length === 0) {
                        list.innerHTML = '<li class="text-muted text-center py-2 no-subgoals"><small>아직 세부 목표가 없습니다</small></li>';
                    }
                } else {
                    alert('오류: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('네트워크 오류가 발생했습니다.');
            });
        });
    });
    
    // 하위 목표 추가
    document.querySelectorAll('.add-subgoal-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.closest('.subgoal-section');
            const input = section.querySelector('.new-subgoal-input');
            const title = input.value.trim();
            
            if (!title) {
                input.focus();
                return;
            }
            
            const goalId = section.dataset.goalId;
            
            fetch(`/planner/ajax/goals/${goalId}/subgoals/add/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `title=${encodeURIComponent(title)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const list = section.querySelector('.subgoal-list');
                    
                    // 빈 메시지 제거
                    const noSubgoals = list.querySelector('.no-subgoals');
                    if (noSubgoals) noSubgoals.remove();
                    
                    // 새 아이템 추가
                    const newItem = document.createElement('li');
                    newItem.className = 'subgoal-item';
                    newItem.dataset.subgoalId = data.subgoal_id;
                    newItem.innerHTML = `
                        <input type="checkbox" class="subgoal-checkbox">
                        <span class="subgoal-title">${escapeHtml(data.title)}</span>
                        <button type="button" class="subgoal-delete" title="삭제">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    list.appendChild(newItem);
                    
                    // 이벤트 바인딩
                    newItem.querySelector('.subgoal-checkbox').addEventListener('change', handleCheckboxChange);
                    newItem.querySelector('.subgoal-delete').addEventListener('click', handleDeleteClick);
                    
                    input.value = '';
                    input.focus();
                    updateSubgoalCounter(section);
                    updateGoalProgressBar(goalId, data.goal_progress, false);
                } else {
                    alert('오류: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('네트워크 오류가 발생했습니다.');
            });
        });
    });
    
    // Enter 키로 하위 목표 추가
    document.querySelectorAll('.new-subgoal-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.closest('.add-subgoal-form').querySelector('.add-subgoal-btn').click();
            }
        });
    });
    
    // HTML 이스케이프
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // 동적으로 추가된 요소용 핸들러
    function handleCheckboxChange() {
        const item = this.closest('.subgoal-item');
        const subgoalId = item.dataset.subgoalId;
        const section = this.closest('.subgoal-section');
        const goalId = section.dataset.goalId;
        
        fetch(`/planner/ajax/subgoals/${subgoalId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_completed) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
                updateSubgoalCounter(section);
                updateGoalProgressBar(goalId, data.goal_progress, data.goal_is_achieved);
                
                if (data.message) {
                    alert(data.message);
                }
            }
        });
    }
    
    function handleDeleteClick() {
        if (!confirm('이 세부 목표를 삭제하시겠습니까?')) return;
        
        const item = this.closest('.subgoal-item');
        const subgoalId = item.dataset.subgoalId;
        const section = this.closest('.subgoal-section');
        const goalId = section.dataset.goalId;
        
        fetch(`/planner/ajax/subgoals/${subgoalId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                item.remove();
                updateSubgoalCounter(section);
                updateGoalProgressBar(goalId, data.goal_progress, data.goal_is_achieved);
                
                const list = section.querySelector('.subgoal-list');
                if (list.querySelectorAll('.subgoal-item').length === 0) {
                    list.innerHTML = '<li class="text-muted text-center py-2 no-subgoals"><small>아직 세부 목표가 없습니다</small></li>';
                }
            }
        });
    }
    
    // 초기 카운터 업데이트
    document.querySelectorAll('.subgoal-section').forEach(section => {
        updateSubgoalCounter(section);
    });
});
</script>
{% endblock %}
