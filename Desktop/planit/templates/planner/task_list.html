{% extends 'base.html' %}

{% block title %}ê³¼ì œ ëª©ë¡ - PlanIt{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ğŸ“ ê³¼ì œ ê´€ë¦¬</h2>
                <div>
                    <a href="{% url 'planner:task_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> ìƒˆ ê³¼ì œ ì¶”ê°€
                    </a>
                    <a href="{% url 'planner:index' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> í”Œë˜ë„ˆ í™ˆ
                    </a>
                </div>
            </div>

            <!-- í•„í„° ë° ì •ë ¬ -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                                    ì „ì²´
                                </button>
                                <button class="btn btn-outline-warning btn-sm filter-btn" data-filter="pending">
                                    ì§„í–‰ì¤‘
                                </button>
                                <button class="btn btn-outline-success btn-sm filter-btn" data-filter="completed">
                                    ì™„ë£Œ
                                </button>
                                <button class="btn btn-outline-danger btn-sm filter-btn" data-filter="overdue">
                                    ì§€ì—°
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end">
                                <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                                    <option value="due_date">ë§ˆê°ì¼ìˆœ</option>
                                    <option value="priority">ìš°ì„ ìˆœìœ„ìˆœ</option>
                                    <option value="created">ìƒì„±ì¼ìˆœ</option>
                                    <option value="subject">ê³¼ëª©ìˆœ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if tasks %}
            <div class="row" id="task-container">
                {% for task in tasks %}
                <div class="col-md-6 col-lg-4 mb-3 task-item" 
                     data-status="{% if task.is_completed %}completed{% elif task.is_overdue %}overdue{% else %}pending{% endif %}"
                     data-priority="{{ task.priority }}"
                     data-due="{{ task.due_date|date:'Y-m-d' }}"
                     data-subject="{{ task.subject.name|default:'ê¸°íƒ€' }}">
                    <div class="card h-100 {% if task.is_overdue and not task.is_completed %}border-danger{% elif task.is_completed %}border-success{% endif %}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                {% if task.priority == 'HIGH' %}
                                <span class="badge bg-danger">ë†’ìŒ</span>
                                {% elif task.priority == 'MEDIUM' %}
                                <span class="badge bg-warning">ë³´í†µ</span>
                                {% else %}
                                <span class="badge bg-secondary">ë‚®ìŒ</span>
                                {% endif %}
                                
                                {% if task.subject %}
                                <span class="badge bg-primary ms-1">{{ task.subject.name }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       {% if task.is_completed %}checked{% endif %}
                                       onchange="toggleTask('{{ task.pk }}', this.checked)">
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <h6 class="card-title {% if task.is_completed %}text-decoration-line-through text-muted{% endif %}">
                                {{ task.title }}
                            </h6>
                            
                            {% if task.description %}
                            <p class="card-text small text-muted">
                                {{ task.description|truncatewords:15 }}
                            </p>
                            {% endif %}
                            
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    ë§ˆê°: {{ task.due_date|date:"mì›” dì¼ H:i" }}
                                </small>
                            </div>
                            
                            {% if task.is_overdue and not task.is_completed %}
                            <div class="alert alert-danger py-1 px-2 small mb-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {{ task.days_overdue }}ì¼ ì§€ì—°
                            </div>
                            {% endif %}
                            
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar {% if task.is_completed %}bg-success{% elif task.is_overdue %}bg-danger{% else %}bg-primary{% endif %}" 
                                     style="width: {% if task.is_completed %}100{% else %}{{ task.progress|default:0 }}{% endif %}%"></div>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-light">
                            <div class="btn-group w-100" role="group">
                                <a href="{% url 'planner:task_detail' task.pk %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'planner:task_edit' task.pk %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'planner:task_delete' task.pk %}" class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-tasks fa-4x text-muted"></i>
                </div>
                <h4 class="text-muted">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                <p class="text-muted">ìƒˆë¡œìš´ ê³¼ì œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                <a href="{% url 'planner:task_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> ì²« ë²ˆì§¸ ê³¼ì œ ì¶”ê°€í•˜ê¸°
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// ê³¼ì œ ì™„ë£Œ í† ê¸€
function toggleTask(taskId, isCompleted) {
    fetch(`{% url 'planner:task_toggle' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// í•„í„°ë§
document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    const taskItems = document.querySelectorAll('.task-item');
    const sortSelect = document.getElementById('sortSelect');
    
    // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // í™œì„± ë²„íŠ¼ ë³€ê²½
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            taskItems.forEach(item => {
                if (filter === 'all' || item.dataset.status === filter) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
    
    // ì •ë ¬
    sortSelect.addEventListener('change', function() {
        const sortBy = this.value;
        const container = document.getElementById('task-container');
        const items = Array.from(taskItems);
        
        items.sort((a, b) => {
            let aVal, bVal;
            
            switch(sortBy) {
                case 'due_date':
                    aVal = new Date(a.dataset.due);
                    bVal = new Date(b.dataset.due);
                    break;
                case 'priority':
                    const priorityOrder = {'HIGH': 3, 'MEDIUM': 2, 'LOW': 1};
                    aVal = priorityOrder[a.dataset.priority] || 0;
                    bVal = priorityOrder[b.dataset.priority] || 0;
                    return bVal - aVal; // ë†’ì€ ìš°ì„ ìˆœìœ„ê°€ ë¨¼ì €
                case 'subject':
                    aVal = a.dataset.subject;
                    bVal = b.dataset.subject;
                    break;
                default:
                    return 0;
            }
            
            if (aVal < bVal) return -1;
            if (aVal > bVal) return 1;
            return 0;
        });
        
        items.forEach(item => container.appendChild(item));
    });
});
</script>

{% csrf_token %}
{% endblock %}
