{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}í”„ë¡œí•„ ìˆ˜ì • - PlanIt{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 mt-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>í”„ë¡œí•„ ìˆ˜ì •
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="profileForm">
                        {% csrf_token %}
                        
                        <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-image me-2"></i>í”„ë¡œí•„ ì´ë¯¸ì§€
                            </label>
                            
                            <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="text-center p-4 mb-3" 
                                 style="border: 2px solid #dee2e6; border-radius: 10px; background-color: #f8f9fa;">
                                <div id="imagePreviewContainer">
                                    {% if user.profile_image %}
                                        <img id="imagePreview" src="{{ user.profile_image.url }}" 
                                             alt="í”„ë¡œí•„ ì´ë¯¸ì§€" 
                                             class="rounded-circle"
                                             style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #e9ecef;">
                                    {% else %}
                                        <div id="avatarPreview" style="font-size: 120px; line-height: 1;">
                                            {% if user.avatar_choice %}
                                                {% if user.avatar_choice == 'default' %}ğŸ‘¤
                                                {% elif user.avatar_choice == 'student_male' %}ğŸ‘¨â€ğŸ“
                                                {% elif user.avatar_choice == 'student_female' %}ğŸ‘©â€ğŸ“
                                                {% elif user.avatar_choice == 'soldier' %}ğŸª–
                                                {% elif user.avatar_choice == 'pilot' %}ğŸ‘¨â€âœˆï¸
                                                {% elif user.avatar_choice == 'engineer' %}ğŸ‘¨â€ğŸ”§
                                                {% elif user.avatar_choice == 'scientist' %}ğŸ‘¨â€ğŸ”¬
                                                {% elif user.avatar_choice == 'astronaut' %}ğŸ‘¨â€ğŸš€
                                                {% endif %}
                                            {% else %}ğŸ‘¤{% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                <p class="text-muted small mb-0 mt-2">í˜„ì¬ í”„ë¡œí•„</p>
                            </div>
                            
                            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                            <div class="mb-3">
                                <input type="file" 
                                       name="profile_image" 
                                       class="form-control" 
                                       id="profileImageInput"
                                       accept="image/*">
                                <div class="form-text">JPG, PNG, GIF í˜•ì‹ ì§€ì› (ìµœëŒ€ 5MB)</div>
                            </div>
                            
                            <!-- ì´ë¯¸ì§€ ì œê±° ì²´í¬ë°•ìŠ¤ -->
                            {% if user.profile_image %}
                            <div class="form-check">
                                <input type="checkbox" 
                                       name="profile_image-clear" 
                                       class="form-check-input" 
                                       id="clearImage">
                                <label class="form-check-label" for="clearImage">
                                    í˜„ì¬ í”„ë¡œí•„ ì´ë¯¸ì§€ ì œê±°
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- í”„ë¡œí•„ ì•„ë°”íƒ€ ì„ íƒ ì„¹ì…˜ (ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ ì‚¬ìš©) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-user-circle me-2"></i>í”„ë¡œí•„ ì•„ë°”íƒ€ (ì´ë¯¸ì§€ ë¯¸ì—…ë¡œë“œ ì‹œ)
                            </label>
                            
                            <!-- ì•„ë°”íƒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                            <select name="avatar_choice" class="form-select" id="avatarSelect">
                                <option value="default" {% if user.avatar_choice == 'default' %}selected{% endif %}>ğŸ‘¤ ê¸°ë³¸ ì•„ë°”íƒ€</option>
                                <option value="student_male" {% if user.avatar_choice == 'student_male' %}selected{% endif %}>ğŸ‘¨â€ğŸ“ ë‚¨í•™ìƒ</option>
                                <option value="student_female" {% if user.avatar_choice == 'student_female' %}selected{% endif %}>ğŸ‘©â€ğŸ“ ì—¬í•™ìƒ</option>
                                <option value="soldier" {% if user.avatar_choice == 'soldier' %}selected{% endif %}>ğŸª– êµ°ì¸</option>
                                <option value="pilot" {% if user.avatar_choice == 'pilot' %}selected{% endif %}>ğŸ‘¨â€âœˆï¸ ì¡°ì¢…ì‚¬</option>
                                <option value="engineer" {% if user.avatar_choice == 'engineer' %}selected{% endif %}>ğŸ‘¨â€ğŸ”§ ì—”ì§€ë‹ˆì–´</option>
                                <option value="scientist" {% if user.avatar_choice == 'scientist' %}selected{% endif %}>ğŸ‘¨â€ğŸ”¬ ê³¼í•™ì</option>
                                <option value="astronaut" {% if user.avatar_choice == 'astronaut' %}selected{% endif %}>ğŸ‘¨â€ğŸš€ ìš°ì£¼ë¹„í–‰ì‚¬</option>
                            </select>
                            <div class="form-text">í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ì•„ë°”íƒ€ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="id_last_name" class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>ì„±
                                </label>
                                <input type="text" 
                                       name="last_name" 
                                       value="{{ form.last_name.value|default:'' }}"
                                       class="form-control" 
                                       id="id_last_name" 
                                       placeholder="ì„±"
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label for="id_first_name" class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>ì´ë¦„
                                </label>
                                <input type="text" 
                                       name="first_name" 
                                       value="{{ form.first_name.value|default:'' }}"
                                       class="form-control" 
                                       id="id_first_name" 
                                       placeholder="ì´ë¦„"
                                       required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_email" class="form-label fw-bold">
                                <i class="fas fa-envelope me-2"></i>ì´ë©”ì¼
                            </label>
                            <input type="email" 
                                   name="email" 
                                   value="{{ form.email.value|default:'' }}"
                                   class="form-control" 
                                   id="id_email" 
                                   placeholder="example@email.com"
                                   required>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="id_department" class="form-label fw-bold">
                                    <i class="fas fa-graduation-cap me-2"></i>í•™ê³¼
                                </label>
                                <select name="department" class="form-select" id="id_department" required>
                                    {% for value, label in form.fields.department.choices %}
                                    <option value="{{ value }}" {% if form.department.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="id_grade" class="form-label fw-bold">
                                    <i class="fas fa-layer-group me-2"></i>í•™ë…„
                                </label>
                                <select name="grade" class="form-select" id="id_grade" required>
                                    {% for value, label in form.fields.grade.choices %}
                                    <option value="{{ value }}" {% if form.grade.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_phone_number" class="form-label fw-bold">
                                <i class="fas fa-phone me-2"></i>ì „í™”ë²ˆí˜¸
                            </label>
                            <input type="text" 
                                   name="phone_number" 
                                   value="{{ form.phone_number.value|default:'' }}"
                                   class="form-control" 
                                   id="id_phone_number" 
                                   placeholder="010-1234-5678">
                        </div>
                        
                        <div class="mb-4">
                            <label for="id_bio" class="form-label fw-bold">
                                <i class="fas fa-pen me-2"></i>ìê¸°ì†Œê°œ
                            </label>
                            <textarea name="bio" 
                                      class="form-control" 
                                      id="id_bio" 
                                      rows="4" 
                                      placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                      maxlength="500">{{ form.bio.value|default:'' }}</textarea>
                            <div class="form-text">ìµœëŒ€ 500ì</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>í”„ë¡œí•„ ì—…ë°ì´íŠ¸
                            </button>
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>ì·¨ì†Œ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ë„ì›€ë§ -->
            <div class="card border-info mt-3">
                <div class="card-body">
                    <h6 class="card-title text-info">
                        <i class="fas fa-lightbulb me-2"></i>í”„ë¡œí•„ ìˆ˜ì • ë„ì›€ë§
                    </h6>
                    <ul class="card-text small mb-0">
                        <li>í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ <strong>ì‹¤ì œ ì‚¬ì§„</strong>ì´ í‘œì‹œë©ë‹ˆë‹¤</li>
                        <li>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ <strong>ì„ íƒí•œ ì•„ë°”íƒ€ ì´ëª¨ì§€</strong>ê°€ í‘œì‹œë©ë‹ˆë‹¤</li>
                        <li>ì´ë¯¸ì§€ íŒŒì¼ì€ JPG, PNG, GIF í˜•ì‹ì„ ì§€ì›í•˜ë©° ìµœëŒ€ 5MBê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>ì „í™”ë²ˆí˜¸ëŠ” 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</li>
                        <li>ìê¸°ì†Œê°œëŠ” ìµœëŒ€ 500ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>í•™ê³¼ì™€ í•™ë…„ ì •ë³´ëŠ” ì‹œê°„í‘œ ë° ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ì—ì„œ í™œìš©ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarSelect = document.getElementById('avatarSelect');
    const avatarPreview = document.getElementById('avatarPreview');
    const phoneInput = document.getElementById('id_phone_number');
    const profileImageInput = document.getElementById('profileImageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const clearImageCheckbox = document.getElementById('clearImage');
    
    // ì•„ë°”íƒ€ ì´ëª¨ì§€ ë§¤í•‘
    const avatarEmojis = {
        'default': 'ğŸ‘¤',
        'student_male': 'ğŸ‘¨â€ğŸ“',
        'student_female': 'ğŸ‘©â€ğŸ“',
        'soldier': 'ğŸª–',
        'pilot': 'ğŸ‘¨â€âœˆï¸',
        'engineer': 'ğŸ‘¨â€ğŸ”§',
        'scientist': 'ğŸ‘¨â€ğŸ”¬',
        'astronaut': 'ğŸ‘¨â€ğŸš€'
    };
    
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    if (profileImageInput) {
        profileImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    e.target.value = '';
                    return;
                }
                
                // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ ì²´í¬
                if (!file.type.startsWith('image/')) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    e.target.value = '';
                    return;
                }
                
                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreviewContainer.innerHTML = `
                        <img id="imagePreview" src="${e.target.result}" 
                             alt="í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" 
                             class="rounded-circle"
                             style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #e9ecef;">
                    `;
                };
                reader.readAsDataURL(file);
                
                // ì´ë¯¸ì§€ ì œê±° ì²´í¬ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ í•´ì œ
                if (clearImageCheckbox) {
                    clearImageCheckbox.checked = false;
                }
            }
        });
    }
    
    // ì´ë¯¸ì§€ ì œê±° ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ
    if (clearImageCheckbox) {
        clearImageCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // ì•„ë°”íƒ€ ì´ëª¨ì§€ë¡œ ë³€ê²½
                const selectedAvatar = avatarSelect.value;
                imagePreviewContainer.innerHTML = `
                    <div id="avatarPreview" style="font-size: 120px; line-height: 1;">
                        ${avatarEmojis[selectedAvatar] || 'ğŸ‘¤'}
                    </div>
                `;
                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                if (profileImageInput) {
                    profileImageInput.value = '';
                }
            }
        });
    }
    
    // ì•„ë°”íƒ€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œë§Œ)
    if (avatarSelect) {
        avatarSelect.addEventListener('change', function() {
            const selectedAvatar = this.value;
            // ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì œê±° ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
            if (avatarPreview || (clearImageCheckbox && clearImageCheckbox.checked)) {
                const preview = document.getElementById('avatarPreview');
                if (preview) {
                    preview.textContent = avatarEmojis[selectedAvatar] || 'ğŸ‘¤';
                }
            }
        });
    }
    
    // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 3 && value.length <= 7) {
                value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
            } else if (value.length > 7) {
                value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
            }
            e.target.value = value;
        });
    }
    
    // í¼ ì œì¶œ ì‹œ í™•ì¸
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        const firstName = document.getElementById('id_first_name').value.trim();
        const lastName = document.getElementById('id_last_name').value.trim();
        const email = document.getElementById('id_email').value.trim();
        
        if (!firstName || !lastName || !email) {
            e.preventDefault();
            alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return false;
        }
    });
});
</script>
{% endblock %}
